<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaticular - Expressive Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': 'var(--color-primary)',
                        'surface-deep': 'var(--color-surface)',
                        'panel-bg': 'var(--color-background)',
                        'text-main': 'var(--color-on-surface)',
                        'text-muted': 'var(--color-on-surface-variant)',
                        'bubble-self': 'var(--color-bubble-self)',
                        'bubble-other': 'var(--color-bubble-other)',
                        'input-bg': 'var(--color-input-bg)',
                        'border-color': 'var(--color-border)',
                        'hover-bg': 'var(--color-hover-bg)',
                        'error': 'var(--color-error)',
                    },
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        /* --- Core Theme Variables (DARK THEME DEFAULT) --- */
        :root {
            /* Vibrant, expressive colors */
            --color-primary: #8B5CF6; /* Violet */
            --color-surface: #0A0A0A; /* Deep Background (Outside App) */
            --color-background: #18181B; /* Panel Background (Slightly Lighter) */
            --color-on-surface: #F0F0F0; /* Main Text */
            --color-on-surface-variant: #A1A1AA; /* Muted Text */
            --color-error: #EF4444; /* Red */
            --color-bubble-self: var(--color-primary);
            --color-on-bubble-self: #FFFFFF;
            --color-bubble-other: #27272A; /* Other person's message bubble */
            --color-on-bubble-other: var(--color-on-surface);
            --color-input-bg: #2C2C30;
            --color-border: #3F3F46;
            --color-hover-bg: #27272A;
            --transition-speed: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- LIGHT THEME OVERRIDES --- */
        body.light-theme {
            --color-surface: #F4F4F5;
            --color-background: #FFFFFF;
            --color-on-surface: #18181B;
            --color-on-surface-variant: #71717A;
            --color-bubble-other: #E4E4E7;
            --color-on-bubble-other: #18181B;
            --color-input-bg: #F9F9FB;
            --color-border: #E5E5E5;
            --color-hover-bg: #F3F4F6;
            --color-primary: #5A67D8; /* Slightly darker primary for visibility */
        }

        /* --- Global Setup & Transitions --- */
        body {
            transition: background-color var(--transition-speed);
            background-color: var(--color-surface);
        }
        * {
            transition: color var(--transition-speed), background-color var(--transition-speed);
        }

        /* --- Application Layout (Mobile-First Sliding Panels) --- */
        /* Use 100vh for height on mobile to cover the whole screen */
        #main-app {
            @apply w-full h-screen max-w-full bg-surface-deep flex relative overflow-hidden;
        }
        
        #contact-panel, #chat-panel {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            transition: transform var(--transition-speed);
            @apply flex flex-col z-10 bg-panel-bg;
        }
        
        #chat-panel {
            transform: translateX(100%); /* Start chat off-screen */
        }
        
        /* Mobile: View Chat State */
        #main-app.view-chat #contact-panel {
            transform: translateX(-100%);
        }
        #main-app.view-chat #chat-panel {
            transform: translateX(0);
            z-index: 20; 
        }

        /* FIX: Ensure Chat Panel content fills space correctly. */
        #chat-active-content {
            @apply flex-col flex-grow h-full;
        }

        /* FIX: Make the chat message container dynamic height, fixed bottom input */
        /* Flex grow container inside a flex container (chat-active-content) */
        #chat-message-container {
            @apply flex-grow overflow-y-auto;
            /* Calculate height: 100% of parent minus fixed header/input area heights */
            /* Using min-h-0 is a flexbox trick to allow scrolling when content overflows */
            min-height: 0; 
        }

        /* FIX: Fixed Input Area on Mobile */
        /* On mobile, use absolute positioning to try and fix it below the keyboard effect */
        @media (max-width: 767px) {
            #chat-input-area {
                position: absolute; /* Changed from default flow for mobile fix */
                bottom: 0;
                width: 100%;
            }
        }

        /* --- Desktop View (768px+) --- */
        @media (min-width: 768px) {
            body { @apply p-6; }
            #main-app {
                /* Larger fixed size for desktop apps */
                @apply w-[95vw] h-[90vh] max-w-[1400px] rounded-3xl shadow-2xl mx-auto;
                position: static;
            }
            
            /* Override Mobile Transitions for Flex layout */
            #contact-panel, #chat-panel {
                position: static;
                transform: translateX(0) !important;
                flex: none; 
                width: auto;
                @apply z-10;
            }

            #contact-panel {
                @apply w-full border-r border-border-color;
                flex-basis: 380px; 
            }

            #chat-panel {
                @apply flex-grow;
            }
            
            /* Desktop: Input area goes back to relative flow */
            #chat-input-area {
                position: relative !important;
                bottom: auto !important;
            }

            /* Desktop Specific: Hide back button and always show content */
            .chat-header-mobile-back { display: none !important; }
            
            /* The Empty state should take up the full height */
            #chat-panel.empty-state {
                @apply flex items-center justify-center;
            }
        }
        
        /* --- Message Bubble Styling --- */
        .message {
            /* Pop/Bounce Animation on Load */
            animation: fadeIn 0.3s ease-out;
            transform-origin: bottom;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sender {
            /* Unique, modern bubble shape */
            border-radius: 1.25rem 1.25rem 0.375rem 1.25rem; 
        }
        
        .message.receiver {
            /* Unique, modern bubble shape */
            border-radius: 1.25rem 1.25rem 1.25rem 0.375rem; 
        }

        /* Scrollbar styling for a cleaner look */
        #chat-message-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-message-container::-webkit-scrollbar-thumb {
            background-color: var(--color-border);
            border-radius: 10px;
        }

        /* --- Touch Menu Styling (Revamped) --- */
        .react-menu {
            /* Use fixed position for proper touch menu behavior */
            position: fixed !important; 
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            min-width: 280px; /* Set a minimum width for better appearance */
        }
        .react-menu .emoji-buttons button {
             @apply p-3 text-2xl bg-hover-bg rounded-full hover:scale-110 active:scale-90 transition-all;
        }

        /* Ensure textarea doesn't overflow its max height */
        #chat-message-input {
            line-height: 1.5; /* Ensure consistent line height */
        }
    </style>
</head>
<body class="dark-theme font-sans">

    <div id="login-container" class="absolute inset-0 flex items-center justify-center p-4 bg-surface-deep transition-opacity duration-500 z-50">
        <div class="p-8 bg-panel-bg rounded-3xl shadow-2xl w-full max-w-sm">
            <h1 class="text-4xl font-extrabold text-primary mb-6 text-center tracking-tight">Chaticular</h1>
            <p class="text-text-muted text-center mb-8">Secure, simple, and expressive messaging.</p>
            
            <input type="text" id="username" placeholder="Username" required 
                   class="w-full p-4 text-lg rounded-xl bg-input-bg text-text-main border-2 border-transparent focus:border-primary focus:ring-2 focus:ring-primary/50 mb-4 transition-all" />
            <input type="password" id="password" placeholder="Password" required 
                   class="w-full p-4 text-lg rounded-xl bg-input-bg text-text-main border-2 border-transparent focus:border-primary focus:ring-2 focus:ring-primary/50 mb-6 transition-all" />
            
            <button onclick="login()" class="w-full py-4 text-lg text-white bg-primary rounded-xl font-bold hover:opacity-90 active:scale-[0.98] shadow-lg shadow-primary/30 transition-all mb-4">
                Login
            </button>
            <button class="secondary-btn w-full py-3 text-lg text-primary bg-transparent border border-primary/50 rounded-xl font-bold hover:bg-primary/10 active:scale-[0.98] transition-all" onclick="signUp()">
                Sign Up
            </button>
            <p class="text-center text-error mt-4 font-medium" id="auth-error"></p>
        </div>
    </div>

    <div id="main-app" class="view-contacts" style="display: none;">
        
        <div id="contact-panel" class="flex-col">
            <div class="p-5 border-b border-border-color sticky top-0 bg-panel-bg z-50 shadow-sm">
                <div id="profile-header" class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-text-main flex items-center">
                        <i data-lucide="messages-square" class="w-7 h-7 mr-2 text-primary"></i> Chats
                    </h2>
                    <div class="flex space-x-2 items-center">
                        <button id="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Theme"
                                class="text-2xl p-3 rounded-full text-text-main hover:bg-hover-bg transition-all active:scale-95">
                            </button>
                        <button id="logout-button" onclick="logout()" 
                                class="p-3 text-error rounded-full hover:bg-error/10 active:scale-95 transition-all" title="Logout">
                            <i data-lucide="log-out" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <p id="logged-in-as" class="text-text-muted text-sm mb-3"></p>
                <input type="text" id="search-username" placeholder="Search contacts..." oninput="searchUsers()"
                       class="w-full p-3 rounded-xl bg-input-bg text-text-main border-2 border-transparent focus:border-primary transition-all"/>
            </div>
            
            <div id="user-container" class="flex-grow overflow-y-auto">
                </div>
        </div>

        <div id="chat-panel" class="empty-state flex flex-col h-full relative">
            
            <div id="empty-message" class="flex items-center justify-center flex-grow text-center p-10">
                 <p class="text-xl text-text-muted italic flex flex-col items-center">
                    <i data-lucide="arrow-left-circle" class="w-10 h-10 mb-4 text-primary opacity-50"></i>
                    üëã Select a contact to start an expressive conversation!
                 </p>
            </div>

            <div id="chat-active-content" class="flex-col flex-grow h-full hidden">
                
                <div id="chat-header" class="p-4 border-b border-border-color flex items-center bg-panel-bg sticky top-0 z-50 shadow-md flex-shrink-0">
                    <button class="chat-header-mobile-back text-2xl text-primary p-1 rounded-full hover:bg-hover-bg mr-2 active:scale-95" onclick="goBackToContacts()">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div id="chat-avatar" class="w-10 h-10 bg-primary/80 rounded-full flex items-center justify-center font-bold text-lg text-white">U</div>
                        <h3 id="chat-username" class="text-xl font-semibold text-text-main"></h3>
                    </div>
                </div>
                
                <div id="chat-message-container" class="flex-grow min-h-0 p-4 overflow-y-auto flex flex-col gap-4">
                    </div>

                <div id="chat-input-area" class="p-3 border-t border-border-color flex items-end gap-2 bg-panel-bg flex-shrink-0">
                    <textarea id="chat-message-input" rows="1" placeholder="Type a message..." oninput="autoResizeTextarea()" onkeypress="handleKeyPress(event)"
                              class="flex-grow p-3 text-base rounded-3xl bg-input-bg text-text-main resize-none overflow-hidden max-h-[100px] border-none focus:ring-2 focus:ring-primary/50 transition-all"></textarea>
                    
                    <button onclick="sendChatMessage()" id="send-btn" class="w-12 h-12 p-3 text-xl font-bold text-white bg-primary rounded-full hover:opacity-90 active:scale-90 flex items-center justify-center transition-all flex-shrink-0" title="Send Message">
                        <i data-lucide="send" class="w-6 h-6 -translate-x-[1px]"></i>
                    </button>
                </div>
            </div>
            
        </div>

        <div class="react-menu bg-panel-bg border border-border-color rounded-2xl shadow-2xl z-[100] transition-all duration-200" 
             id="react-menu" style="display: none; top: 0; left: 0;">
            
            <h4 class="text-text-muted text-xs font-medium mb-2 text-center">React:</h4>
            <div class="emoji-buttons flex gap-2 justify-center mb-3">
                <button onclick="reactToMessage('üëç')" title="Like" class="p-3">üëç</button>
                <button onclick="reactToMessage('‚ù§Ô∏è')" title="Love" class="p-3">‚ù§Ô∏è</button>
                <button onclick="reactToMessage('üòÇ')" title="Laugh" class="p-3">üòÇ</button>
                <button onclick="reactToMessage('üí°')" title="Idea" class="p-3">üí°</button>
                <button onclick="reactToMessage('üî•')" title="Fire" class="p-3">üî•</button>
            </div>

            <button id="delete-btn" onclick="deleteMessage()" 
                    class="w-full py-3 px-3 text-base font-semibold text-white bg-error rounded-xl hover:bg-error/90 active:scale-[0.98] transition-all flex items-center justify-center">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i> Delete Message
            </button>
        </div>

    </div>

    <script>
        // Initialize Lucide Icons after DOM load
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
        
        // --- FIREBASE CONFIG & INITIALIZATION (UNCHANGED) ---
        // Global variables are automatically provided by the Canvas environment.
        const firebaseConfig = {
            apiKey: "AIzaSyDrTPRrIseMyXbmzXMNRniMoALQoq-IdZ0",
            authDomain: "chaticular.firebaseapp.com",
            projectId: "chaticular",
            storageBucket: "chaticular.appspot.com",
            messagingSenderId: "570690886660",
            appId: "1:570690886660:web:6b837cea403c2466722951"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // NOTE: storage is no longer needed since image upload was removed.
        // const storage = firebase.storage(); 

        let currentChatUser = '';
        let currentMessageRef = null; 
        let unsubscribeChatListener = null;

        // --- THEME MANAGEMENT (UNCHANGED LOGIC, UPDATED SELECTORS) ---
        const body = document.body;
        const themeToggle = document.getElementById('theme-toggle');

        function updateThemeIcon() {
            // Use Lucide Icons
            themeToggle.innerHTML = body.classList.contains('light-theme') 
                ? '<i data-lucide="moon" class="w-6 h-6"></i>' 
                : '<i data-lucide="sun" class="w-6 h-6"></i>';
            lucide.createIcons();
        }

        function toggleTheme() {
            const isLight = body.classList.toggle('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            updateThemeIcon();
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                body.classList.add('light-theme');
            } else {
                body.classList.remove('light-theme');
            }
            updateThemeIcon();
        }

        // --- UTILITIES (UNCHANGED) ---

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return '...';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const day = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
            return `${time} ${day}`;
        };
        
        function getAuthErrorElement() {
            return document.getElementById('auth-error');
        }

        function getInitials(username) {
            if (!username) return 'U';
            const parts = username.split(/[\s.]+/).filter(Boolean);
            if (parts.length > 1) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return username[0].toUpperCase();
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById("chat-message-input");
            textarea.style.height = 'auto'; // Reset height
            // Set to scrollHeight but cap at 100px (max-h-[100px] in Tailwind)
            const newHeight = Math.min(textarea.scrollHeight, 100); 
            textarea.style.height = newHeight + 'px';
        }

        // --- VIEW MANAGEMENT (MODIFIED TO USE NEW STRUCTURE) ---
        const mainApp = document.getElementById('main-app');
        const chatPanel = document.getElementById('chat-panel');
        const chatMessageContainer = document.getElementById("chat-message-container");
        
        const isMobileView = () => window.matchMedia("(max-width: 767px)").matches;

        function showView(viewName) {
            const isChat = viewName === 'chat';

            // 1. Mobile Transition Logic
            if (isMobileView()) {
                mainApp.classList.remove('view-chat', 'view-contacts');
                mainApp.classList.add(isChat ? 'view-chat' : 'view-contacts');
            } else {
                // Desktop: Always show both panels
                mainApp.classList.remove('view-chat', 'view-contacts');
                mainApp.classList.add('view-contacts');
            }

            // 2. Content Visibility Logic (Toggling the empty state class)
            chatPanel.classList.toggle('empty-state', !isChat);
            document.getElementById('chat-active-content').classList.toggle('hidden', !isChat); // New content wrapper
            document.getElementById('empty-message').classList.toggle('hidden', isChat);

            if (isChat) {
                // Scroll to bottom when showing chat view
                setTimeout(() => chatMessageContainer.scrollTo({ top: chatMessageContainer.scrollHeight, behavior: 'instant' }), 100);
            }
        }

        function goBackToContacts() {
            showView('contacts');
            currentChatUser = '';
            if (unsubscribeChatListener) { 
                unsubscribeChatListener(); 
                unsubscribeChatListener = null; 
            }
            // Remove active state from all contact items
            document.querySelectorAll('.user-item').forEach(item => item.classList.remove('bg-primary/20', 'active'));
            document.getElementById('chat-username').textContent = '';
            document.getElementById('chat-avatar').textContent = 'U';
            document.getElementById('react-menu').style.display = 'none'; // Hide menu on back
        }

        // --- AUTH & INITIALIZATION (UNCHANGED LOGIC) ---

        window.onload = () => {
            loadThemePreference();
            const username = localStorage.getItem('username');
            if (username) {
                document.getElementById("login-container").style.display = "none";
                document.getElementById("main-app").style.display = "flex";
                loginSuccess(username);
            } else {
                document.getElementById("login-container").style.display = "flex";
                document.getElementById("main-app").style.display = "none";
            }
        };

        function loginSuccess(username) {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("main-app").style.display = "flex";
            document.getElementById("logged-in-as").textContent = `Logged in as: ${username}`;
            loadAllUsers();
            showView('contacts');
        }

        function logout() {
            localStorage.removeItem('username');
            goBackToContacts();
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
            document.getElementById('auth-error').textContent = "";
            document.getElementById("login-container").style.display = "flex";
            document.getElementById("main-app").style.display = "none";
        }

        function signUp() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const errorElement = getAuthErrorElement();
            errorElement.textContent = "";

            if (username.length < 4 || password.length < 6) {
                errorElement.textContent = "Username must be 4+ chars, Password must be 6+ chars!";
                return;
            }

            db.collection("users").doc(username).get().then((doc) => {
                if (doc.exists) {
                    errorElement.textContent = "Username already taken! Try logging in.";
                } else {
                    db.collection("users").doc(username).set({
                        username: username,
                        password: password,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        localStorage.setItem('username', username);
                        loginSuccess(username);
                    })
                    .catch(error => {
                        errorElement.textContent = `Error signing up: ${error.message}`;
                    });
                }
            });
        }

        function login() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const errorElement = getAuthErrorElement();
            errorElement.textContent = "";

            if (!username || !password) {
                errorElement.textContent = "Please enter both username and password!";
                return;
            }

            db.collection("users").doc(username).get().then((doc) => {
                if (doc.exists && doc.data().password === password) {
                    localStorage.setItem('username', username);
                    loginSuccess(username);
                } else {
                    errorElement.textContent = "Invalid username or password!";
                }
            }).catch((error) => {
                errorElement.textContent = `Error logging in: ${error.message}`;
            });
        }

        // --- USER LIST & SEARCH (MODIFIED RENDER/STYLE) ---

        function loadAllUsers() {
            const currentUser = localStorage.getItem('username');
            db.collection("users").orderBy("username").onSnapshot((querySnapshot) => {
                const userContainer = document.getElementById("user-container");
                userContainer.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (userData.username !== currentUser) {
                        renderUserItem(userData.username, userContainer);
                    }
                });
            }, error => console.error("Error listening to users: ", error));
        }

        function searchUsers() {
            const searchTerm = document.getElementById("search-username").value.toLowerCase();
            const allUsers = document.querySelectorAll('.user-item');
            
            allUsers.forEach(item => {
                const usernameText = item.querySelector('.username-text').textContent.toLowerCase();
                item.style.display = usernameText.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function renderUserItem(username, container) {
            const userDiv = document.createElement("div");
            userDiv.classList.add("user-item", "p-4", "cursor-pointer", "border-b", "border-border-color", "flex", "items-center", "gap-4", "hover:bg-hover-bg", "transition-all", "duration-200");
            
            if (username === currentChatUser) {
                userDiv.classList.add("bg-primary/20", "active"); 
            }
            
            userDiv.innerHTML = `
                <div class="user-item-avatar w-12 h-12 bg-primary/80 rounded-full flex items-center justify-center font-bold text-xl text-white shadow-md">${getInitials(username)}</div>
                <span class="username-text text-text-main text-lg font-medium">${username}</span>
            `;
            
            userDiv.onclick = () => {
                startChat(username);
            };
            container.appendChild(userDiv);
        }

        // --- CHAT CORE FUNCTIONS (MODIFIED sendChatMessage FOR NO IMAGE UPLOAD) ---

        function startChat(username) {
            if (unsubscribeChatListener) {
                unsubscribeChatListener();
            }

            // Update active state visuals
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('bg-primary/20', 'active');
                if (item.querySelector('.username-text').textContent.trim() === username) {
                    item.classList.add('bg-primary/20', 'active');
                }
            });

            currentChatUser = username;
            document.getElementById("chat-username").textContent = username;
            document.getElementById("chat-avatar").textContent = getInitials(username);
            showView('chat');
            loadChatMessages();
        }

        function loadChatMessages() {
            const username = localStorage.getItem('username');

            unsubscribeChatListener = db.collection("direct_messages").doc(username).collection(currentChatUser)
                .orderBy("timestamp", "asc")
                .onSnapshot((querySnapshot) => {
                    // Check if scrolled near bottom before update
                    const wasScrolledToBottom = chatMessageContainer.scrollHeight - chatMessageContainer.scrollTop <= chatMessageContainer.clientHeight + 100;
                    
                    // Store current content before clearing
                    const oldContent = Array.from(chatMessageContainer.children).map(el => el.getAttribute('data-id'));
                    
                    chatMessageContainer.innerHTML = ""; 
                    
                    querySnapshot.forEach((doc) => {
                        const messageData = doc.data();
                        
                        const messageDiv = document.createElement("div");
                        messageDiv.classList.add("message", "max-w-[80%]", "py-3", "px-4", "relative", "cursor-pointer", "shadow-lg", "select-none");
                        messageDiv.classList.add(messageData.sender === username ? "sender" : "receiver", "text-base", "self-start", "transition-all");

                        // Apply new message animation class if it's a new message
                        if (!oldContent.includes(doc.id)) {
                            messageDiv.classList.add('new-message'); 
                        }

                        // Apply sender/receiver specific colors and alignment
                        if (messageData.sender === username) {
                            messageDiv.classList.add("bg-bubble-self", "text-white", "ml-auto");
                        } else {
                            messageDiv.classList.add("bg-bubble-other", "text-text-main", "mr-auto");
                        }

                        messageDiv.setAttribute('data-id', doc.id);
                        messageDiv.onclick = (event) => showReactionMenu(event, doc.id, messageData.sender);

                        let contentHTML = messageData.content ? `<span class="message-content">${messageData.content}</span>` : '';
                        
                        // Image Display Logic (kept in case old messages had images, but upload is removed)
                        if (messageData.imageUrl) {
                            const placeholder = 'https://placehold.co/200x150/2C2C30/A1A1AA?text=Image+Load+Fail';
                            contentHTML += `<img src="${messageData.imageUrl}" onerror="this.onerror=null;this.src='${placeholder}';" alt="Attached Image" class="max-w-full rounded-xl mt-1 block object-cover max-h-[250px] transition-all duration-300 hover:scale-[1.01] cursor-pointer"/>`;
                        }
                        
                        let reactionHTML = '';
                        if (messageData.reactions && Object.keys(messageData.reactions).length > 0) {
                            // Simplified reaction mapping to only show emoji, count, and color (no Lucide icons in the pills)
                            const reactionColors = {
                                'üëç': 'text-blue-500',
                                '‚ù§Ô∏è': 'text-red-500',
                                'üòÇ': 'text-yellow-500',
                                'üí°': 'text-yellow-300',
                                'üî•': 'text-orange-500'
                            };
                            
                            const uniqueReactionsMap = {};
                            Object.values(messageData.reactions).forEach(emoji => {
                                uniqueReactionsMap[emoji] = (uniqueReactionsMap[emoji] || 0) + 1;
                            });

                            const reactionPills = Object.entries(uniqueReactionsMap).map(([emoji, count]) => {
                                const colorClass = reactionColors[emoji] || 'text-text-main';
                                
                                return `<span class="flex items-center text-xs font-semibold mr-1 transition-all hover:scale-105 ${colorClass}">
                                            ${emoji} ${count > 1 ? count : ''}
                                        </span>`;
                            }).join('');


                            reactionHTML = `<div class="reactions absolute -bottom-3 right-0 bg-panel-bg border border-border-color py-1 px-2 rounded-full text-xs shadow-xl flex items-center transform translate-x-1/4 select-none">
                                ${reactionPills}
                            </div>`;
                        }

                        messageDiv.innerHTML = `
                            ${contentHTML}
                            <span class="message-timestamp block mt-1 text-xs opacity-70 ${messageData.sender === username ? 'text-right' : 'text-left'}">
                                ${formatTimestamp(messageData.timestamp)}
                            </span>
                            ${reactionHTML}
                        `;
                        
                        chatMessageContainer.appendChild(messageDiv);
                        // Re-create icons for the new messages
                        // NOTE: Only need to run if using Lucide in pills. Since we removed it, this is less critical but kept for other uses (send button).
                        lucide.createIcons(messageDiv); 
                    });
                    
                    // Smooth scroll on new message or if already at bottom
                    if (wasScrolledToBottom || querySnapshot.docChanges().some(change => change.type === 'added')) {
                        setTimeout(() => chatMessageContainer.scrollTo({ top: chatMessageContainer.scrollHeight, behavior: 'smooth' }), 50);
                    }
                }, error => {
                    console.error("Error listening to chat messages: ", error);
                });
        }

        async function sendChatMessage() {
            const messageInput = document.getElementById("chat-message-input");
            const message = messageInput.value.trim();
            const username = localStorage.getItem('username');

            // Simplified check: only need content
            if (!message) {
                // Animated error feedback
                messageInput.classList.add('border-2', 'border-error', 'animate-pulse');
                setTimeout(() => messageInput.classList.remove('border-2', 'border-error', 'animate-pulse'), 1000);
                return;
            }
            
            // Disable button and show loading state
            const sendButton = document.getElementById('send-btn');
            sendButton.innerHTML = '<i data-lucide="loader-circle" class="w-6 h-6 animate-spin"></i>'; // Larger icon for larger button
            lucide.createIcons(sendButton);

            const messageData = {
                content: message,
                sender: username,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                imageUrl: null, // Always null now
                reactions: {}
            };
            
            // --- CORE FIRESTORE LOGIC ---
            const batch = db.batch();
            const newDocRef = db.collection("direct_messages").doc(username).collection(currentChatUser).doc();
            const receiverDocRef = db.collection("direct_messages").doc(currentChatUser).collection(username).doc(newDocRef.id);

            batch.set(newDocRef, messageData);
            batch.set(receiverDocRef, messageData);

            batch.commit().then(() => {
                messageInput.value = "";
                autoResizeTextarea(); 
                
                // Restore button state
                sendButton.innerHTML = '<i data-lucide="send" class="w-6 h-6 -translate-x-[1px]"></i>';
                lucide.createIcons(sendButton);
            }).catch(error => {
                console.error("Error sending message in batch: ", error);
                // Restore button state
                sendButton.innerHTML = '<i data-lucide="send" class="w-6 h-6 -translate-x-[1px]"></i>';
                lucide.createIcons(sendButton);
            });
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // --- MESSAGE CONTEXT (REACTIONS/DELETE) (REWRITTEN POSITIONING) ---

        function showReactionMenu(event, messageId, messageSender) {
            event.stopPropagation();
            const menu = document.getElementById('react-menu');
            const deleteButton = document.getElementById('delete-btn');
            const currentUser = localStorage.getItem('username');
            const messageElement = event.currentTarget;
            const rect = messageElement.getBoundingClientRect();

            currentMessageRef = { id: messageId, sender: messageSender };

            // Show/Hide delete button based on ownership
            deleteButton.style.display = (messageSender === currentUser) ? 'flex' : 'none';

            // Reset menu position styles for recalculation
            menu.style.display = 'flex';
            menu.style.transform = 'none';

            // 1. Calculate ideal position (centered above message)
            let menuX = rect.left + (rect.width / 2); // Center of the message bubble
            let menuY = rect.top; // Top edge of the message bubble

            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            const padding = 10; // Padding from screen edges

            // 2. Adjust X (Horizontal)
            let finalX = menuX - (menuWidth / 2);

            // Left boundary check
            if (finalX < padding) {
                finalX = padding;
            }
            // Right boundary check
            else if (finalX + menuWidth > window.innerWidth - padding) {
                finalX = window.innerWidth - menuWidth - padding;
            }

            // 3. Adjust Y (Vertical) - Try above first
            let finalY = menuY - menuHeight - padding;

            // Top boundary check: if it goes off screen top, move it below
            if (finalY < padding) {
                finalY = rect.bottom + padding;
            }

            // 4. Apply final position
            menu.style.left = `${finalX}px`;
            menu.style.top = `${finalY}px`;
            
            // 5. Setup auto-hide on outside click
            const hideMenu = (e) => {
                if (!menu.contains(e.target) && e.target !== event.currentTarget) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', hideMenu);
                }
            };
            // Use setTimeout to allow the current click event to complete before setting up the listener
            setTimeout(() => document.addEventListener('click', hideMenu), 0);
        }

        async function reactToMessage(emoji) {
            const menu = document.getElementById('react-menu');
            menu.style.display = 'none';

            if (!currentMessageRef || !currentChatUser) return;
            const { id: messageId } = currentMessageRef;
            const username = localStorage.getItem('username');

            // --- CORE FIRESTORE LOGIC (UNCHANGED) ---
            const docRefSender = db.collection("direct_messages").doc(username).collection(currentChatUser).doc(messageId);
            const docRefReceiver = db.collection("direct_messages").doc(currentChatUser).collection(username).doc(messageId);

            const reactionField = `reactions.${username}`;
            
            const batch = db.batch();
            batch.update(docRefSender, { [reactionField]: emoji });
            batch.update(docRefReceiver, { [reactionField]: emoji });
            
            try {
                await batch.commit();
            } catch (error) {
                console.error("Error reacting to message: ", error);
            }
        }

        async function deleteMessage() {
            const menu = document.getElementById('react-menu');
            menu.style.display = 'none';
            
            if (!currentMessageRef || !currentChatUser) return;
            const { id: messageId, sender: messageSender } = currentMessageRef;
            const currentUser = localStorage.getItem('username');

            if (messageSender !== currentUser) {
                return;
            }

            // --- CORE FIRESTORE LOGIC (UNCHANGED) ---
            const docRefSender = db.collection("direct_messages").doc(currentUser).collection(currentChatUser).doc(messageId);
            const docRefReceiver = db.collection("direct_messages").doc(currentChatUser).collection(currentUser).doc(messageId);

            const batch = db.batch();
            batch.delete(docRefSender);
            batch.delete(docRefReceiver);

            try {
                await batch.commit();
            } catch (error) {
                console.error("Error deleting message: ", error);
            }
        }
    </script>
</body>
</html>
