<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CronoTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f0f2f5;
            --bg-dark: #121212;
            --text-light: #1c1c1e;
            --text-dark: #e5e5e7;
            --glass-bg-light: rgba(255, 255, 255, 0.35);
            --glass-bg-dark: rgba(30, 30, 30, 0.5);
            --glass-border-light: rgba(255, 255, 255, 0.4);
            --glass-border-dark: rgba(50, 50, 50, 0.6);
            --primary-accent: #4c82f7;
            --font-scale: 1.0;
        }

        html {
            touch-action: manipulation;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: calc(16px * var(--font-scale));
        }

        .splash-screen {
            animation: fadeOut 2.5s forwards;
            animation-delay: 1.5s;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        .page.hidden {
            display: none;
        }

        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-fade-in {
            animation: pageFadeIn 0.3s ease-out forwards;
        }

        .glass-effect {
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
        }

        html.light .glass-effect {
            background-color: var(--glass-bg-light);
            border: 1px solid var(--glass-border-light);
        }

        html.dark .glass-effect {
            background-color: var(--glass-bg-dark);
            border: 1px solid var(--glass-border-dark);
        }
        
        .side-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        .side-menu.open {
            transform: translateX(0);
        }
        
        .backdrop {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .backdrop.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Custom slider styles for better touch */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            padding: 10px 0; /* Add padding to make the touch area larger */
        }
        
        input[type=range]:focus {
            outline: none;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(76, 130, 247, 0.5);
            border-radius: 6px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -11px;
            border: 2px solid var(--primary-accent);
            box-shadow: 0 0 10px rgba(76, 130, 247, 0.5);
        }

        input[type=range]::-moz-range-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: rgba(76, 130, 247, 0.5);
            border-radius: 6px;
        }

        input[type=range]::-moz-range-thumb {
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--primary-accent);
            box-shadow: 0 0 10px rgba(76, 130, 247, 0.5);
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-gray-100 overflow-hidden h-screen w-screen fixed inset-0">

    <!-- Splash Screen -->
    <div id="splash-screen" class="splash-screen fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-100 dark:bg-black">
        <svg class="w-20 h-20 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
        <h1 class="text-4xl font-black mt-4 tracking-tighter">CronoTrack</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Focus, tracked.</p>
    </div>

    <!-- App Wrapper -->
    <div id="app-wrapper" class="h-full w-full">
        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 z-20 p-4 flex justify-between items-center">
            <button id="menu-btn" class="p-3 active:opacity-50 transition-transform active:scale-90">
                <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
            <div class="flex items-center gap-2 glass-effect rounded-full px-4 py-2">
                 <svg class="w-5 h-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.82 15.82-1.42 1.42-1.4-1.4-1.42-1.42-1.4 1.4-1.42-1.42-1.42 1.4-1.42 1.42-1.4-1.4-1.42 1.42-1.4-1.4-1.42-1.42 1.4-1.4 1.42-1.42 1.4-1.4 1.42-1.42 1.42 1.4 1.42 1.42 1.4-1.4 1.42 1.42Z"/><path d="M12 22s-4-2-4-8 4-8 4-8 4 2 4 8-4 8-4 8Z"/></svg>
                <span id="points-display" class="font-bold text-lg">0</span>
            </div>
        </header>

        <!-- Side Menu -->
        <div id="backdrop" class="backdrop fixed inset-0 z-30 bg-black/50"></div>
        <nav id="side-menu" class="side-menu fixed top-0 left-0 h-full w-4/5 max-w-sm z-40 glass-effect p-6 flex flex-col">
            <div class="flex items-center justify-between mb-12">
                <h2 class="text-3xl font-black tracking-tighter">CronoTrack</h2>
                <button id="close-menu-btn" class="p-3 active:opacity-50 transition-transform active:scale-90">
                    <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <ul class="flex flex-col gap-2">
                <li><a href="#pomodoro" class="nav-link text-xl font-bold p-4 block rounded-lg active:bg-white/10 transition-transform active:scale-95" data-page="pomodoro-page">Pomodoro</a></li>
                <li><a href="#tasks" class="nav-link text-xl font-bold p-4 block rounded-lg active:bg-white/10 transition-transform active:scale-95" data-page="tasks-page">Tasks</a></li>
                <li><a href="#settings" class="nav-link text-xl font-bold p-4 block rounded-lg active:bg-white/10 transition-transform active:scale-95" data-page="settings-page">Settings</a></li>
                <li><a href="#data" class="nav-link text-xl font-bold p-4 block rounded-lg active:bg-white/10 transition-transform active:scale-95" data-page="data-page">Data & Info</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="h-full w-full pt-20">
            <!-- Pomodoro Page -->
            <div id="pomodoro-page" class="page h-full w-full flex flex-col items-center justify-between p-4">
                <div class="w-full flex justify-center items-center flex-grow flex-col">
                    <div class="relative w-72 h-72 sm:w-80 sm:h-80 flex items-center justify-center">
                        <svg class="absolute inset-0 transform -rotate-90" viewBox="0 0 120 120">
                            <circle class="text-gray-200 dark:text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60" />
                            <circle id="timer-progress" class="text-blue-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="52" cx="60" cy="60"
                                    stroke-dasharray="326.72" stroke-dashoffset="326.72"/>
                        </svg>
                        <div class="flex flex-col items-center">
                            <h3 id="timer-mode" class="text-lg font-semibold text-gray-500 dark:text-gray-400">Focus</h3>
                            <h1 id="timer-display" class="text-7xl font-black tracking-tighter">25:00</h1>
                        </div>
                    </div>
                    <div class="w-full max-w-sm p-4 space-y-4 mt-4">
                        <div id="pomodoro-slider-container">
                            <div class="flex justify-between items-baseline mb-1">
                                <label for="pomodoro-slider" class="font-bold">Focus Time</label>
                                <span id="pomodoro-slider-value" class="font-semibold">25 min</span>
                            </div>
                            <input type="range" id="pomodoro-slider" min="1" max="6" value="2" class="w-full">
                        </div>
                         <div id="break-slider-container">
                            <div class="flex justify-between items-baseline mb-1">
                                <label for="break-slider" class="font-bold">Break Time</label>
                                <span id="break-slider-value" class="font-semibold">5 min</span>
                            </div>
                            <input type="range" id="break-slider" min="1" max="3" value="1" class="w-full">
                        </div>
                    </div>
                </div>
                <div class="w-full max-w-md pb-4 px-4">
                    <div class="flex items-center justify-center gap-4">
                         <button id="reset-btn" class="p-4 active:opacity-50 transition-transform active:scale-90">
                            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                        </button>
                        <button id="start-pause-btn" class="w-20 h-20 bg-blue-500 text-white rounded-full flex items-center justify-center text-xl font-bold active:opacity-80 shadow-lg transition-transform active:scale-95">
                            <svg id="play-icon" class="w-10 h-10 ml-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M8 5v14l11-7z"/></svg>
                             <svg id="pause-icon" class="w-10 h-10 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                         <button id="skip-btn" class="p-4 active:opacity-50 transition-transform active:scale-90">
                            <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 4 10 8-10 8V4z"/><path d="M19 4v16"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasks-page" class="page hidden h-full w-full flex flex-col items-center justify-center p-4">
                <h2 class="text-4xl font-black mb-4">Tasks</h2>
                <p class="text-lg text-gray-500 dark:text-gray-400">Coming Soon!</p>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page hidden h-full w-full flex flex-col p-4 overflow-y-auto">
                <h2 class="text-4xl font-black mb-6 px-2">Settings</h2>
                
                <!-- Appearance Settings Card -->
                <div class="glass-effect rounded-2xl p-4 mb-6">
                    <h3 class="font-bold text-lg px-2 mb-2">Appearance</h3>
                    <div class="divide-y divide-gray-500/20">
                        <div class="flex items-center justify-between py-3 px-2">
                            <div class="flex items-center gap-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                                <label for="theme-toggle" class="font-semibold">Dark Mode</label>
                            </div>
                            <button id="theme-toggle" class="relative inline-flex items-center h-8 rounded-full w-14 transition-colors">
                                <span class="absolute inline-block w-6 h-6 transform bg-white rounded-full transition-transform" id="theme-toggle-indicator"></span>
                            </button>
                        </div>
                        <div class="flex flex-col py-3 px-2">
                            <div class="flex items-center gap-4">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M4 21V9a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12"/><path d="M4 7V5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2"/><path d="M12 15a2 2 0 1 1-4 0 2 2 0 0 1 4 0Z"/></svg>
                                <label for="text-size-slider" class="font-semibold">Text Size</label>
                            </div>
                            <div class="flex items-center gap-4 mt-3">
                               <span class="text-sm font-bold">A</span>
                               <input type="range" id="text-size-slider" min="0.8" max="1.3" step="0.1" value="1.0" class="w-full">
                               <span class="text-2xl font-bold">A</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Card -->
                 <div class="glass-effect rounded-2xl p-4">
                    <h3 class="font-bold text-lg px-2 mb-2">About</h3>
                     <div class="divide-y divide-gray-500/20 text-sm">
                        <div class="flex items-center justify-between py-3 px-2">
                            <p class="font-semibold">App Version</p>
                            <p class="text-gray-500 dark:text-gray-400">1.0.1</p>
                        </div>
                        <div class="flex items-center justify-between py-3 px-2">
                            <p class="font-semibold">Creator</p>
                            <p class="text-gray-500 dark:text-gray-400">Preran P</p>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Data Page -->
            <div id="data-page" class="page hidden h-full w-full flex flex-col p-4 overflow-y-auto">
                 <h2 class="text-4xl font-black mb-6 px-2">Data & Info</h2>
                 <div class="space-y-4">
                     <button id="reset-app-btn" class="w-full text-left font-bold text-lg p-4 rounded-2xl bg-red-500/10 text-red-500 active:bg-red-500/20 transition-transform active:scale-95 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                        Reset App
                    </button>
                     <button id="export-data-btn" class="w-full text-left font-bold text-lg p-4 rounded-2xl bg-blue-500/10 text-blue-500 active:bg-blue-500/20 transition-transform active:scale-95 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        Export Data
                    </button>
                     <button id="import-data-btn" class="w-full text-left font-bold text-lg p-4 rounded-2xl bg-green-500/10 text-green-500 active:bg-green-500/20 transition-transform active:scale-95 flex items-center gap-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        Import Data
                    </button>
                     <input type="file" id="import-file-input" class="hidden" accept=".json">
                 </div>
            </div>
            
            <!-- Custom Alert Modal -->
            <div id="alert-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
                <div class="glass-effect rounded-2xl p-6 w-full max-w-sm text-center">
                    <h3 id="alert-title" class="text-xl font-bold mb-2"></h3>
                    <p id="alert-message" class="text-gray-800 dark:text-gray-200 mb-6"></p>
                    <div id="alert-actions" class="flex gap-4">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let timerInterval = null;
            let timeLeft = 1500; // 25 minutes in seconds
            let totalTime = 1500;
            let timerMode = 'pomodoro'; // 'pomodoro' or 'break'
            let timerState = 'stopped'; // 'stopped', 'running', 'paused'
            let points = 0;
            
            const pomodoroDurations = { 1: 900, 2: 1500, 3: 2700, 4: 3600, 5: 4500, 6: 5400 }; // 15m to 1h30m
            const breakDurations = { 1: 300, 2: 600, 3: 900 }; // 5m to 15m

            // --- DOM ELEMENTS ---
            const body = document.body;
            const appWrapper = document.getElementById('app-wrapper');
            const splashScreen = document.getElementById('splash-screen');
            const menuBtn = document.getElementById('menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const backdrop = document.getElementById('backdrop');
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const pointsDisplay = document.getElementById('points-display');
            const timerDisplay = document.getElementById('timer-display');
            const timerModeDisplay = document.getElementById('timer-mode');
            const timerProgress = document.getElementById('timer-progress');
            const startPauseBtn = document.getElementById('start-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const resetBtn = document.getElementById('reset-btn');
            const skipBtn = document.getElementById('skip-btn');
            const pomodoroSlider = document.getElementById('pomodoro-slider');
            const pomodoroSliderValue = document.getElementById('pomodoro-slider-value');
            const breakSlider = document.getElementById('break-slider');
            const breakSliderValue = document.getElementById('break-slider-value');
            const pomodoroSliderContainer = document.getElementById('pomodoro-slider-container');
            const breakSliderContainer = document.getElementById('break-slider-container');

            // Settings
            const themeToggle = document.getElementById('theme-toggle');
            const themeToggleIndicator = document.getElementById('theme-toggle-indicator');
            const textSizeSlider = document.getElementById('text-size-slider');

            // Data
            const resetAppBtn = document.getElementById('reset-app-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            
            // Modal
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertActions = document.getElementById('alert-actions');

            // --- INITIALIZATION ---
            const init = () => {
                loadSettings();
                updatePointsDisplay();
                resetTimer();
                splashScreen.addEventListener('animationend', () => {
                    splashScreen.style.display = 'none';
                });
            };

            // --- LOCAL STORAGE & SETTINGS ---
            const saveSettings = () => {
                const settings = {
                    points: points,
                    theme: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
                    textSize: document.documentElement.style.getPropertyValue('--font-scale'),
                    pomodoroDurationKey: pomodoroSlider.value,
                    breakDurationKey: breakSlider.value
                };
                localStorage.setItem('cronoTrackSettings', JSON.stringify(settings));
            };

            const loadSettings = () => {
                // Set defaults first
                document.documentElement.classList.add('dark');
                document.documentElement.style.setProperty('--font-scale', '1.0');
                updateThemeToggleUI();
                
                const settings = JSON.parse(localStorage.getItem('cronoTrackSettings'));
                if (settings) {
                    points = settings.points || 0;
                    
                    // Theme - apply only if it's 'light' since dark is default
                    if (settings.theme === 'light') {
                        document.documentElement.classList.remove('dark');
                    }
                    updateThemeToggleUI();

                    // Text Size
                    const textSize = settings.textSize || '1.0';
                    document.documentElement.style.setProperty('--font-scale', textSize);
                    textSizeSlider.value = parseFloat(textSize);

                    // Timer durations
                    pomodoroSlider.value = settings.pomodoroDurationKey || 2;
                    breakSlider.value = settings.breakDurationKey || 1;
                }
                
                updatePomodoroSliderDisplay();
                updateBreakSliderDisplay();
            };

            const resetAppSettings = () => {
                localStorage.removeItem('cronoTrackSettings');
                points = 0;
                pomodoroSlider.value = 2;
                breakSlider.value = 1;
                textSizeSlider.value = 1.0;
                // Reload settings to apply defaults
                loadSettings();
                resetTimer();
                updatePointsDisplay();
            };

            // --- UI FUNCTIONS ---
            const updateTimerDisplay = () => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                const progress = (totalTime - timeLeft) / totalTime;
                const circumference = 2 * Math.PI * 52; // 2 * pi * radius
                timerProgress.style.strokeDashoffset = circumference * (1 - progress);
            };

            const updatePointsDisplay = () => {
                pointsDisplay.textContent = points;
            };

            const toggleMenu = () => {
                sideMenu.classList.toggle('open');
                backdrop.classList.toggle('open');
            };

            const showPage = (pageId) => {
                let foundPage = false;
                pages.forEach(page => {
                    if (page.id === pageId) {
                        page.classList.remove('hidden');
                        page.classList.add('page-fade-in');
                        foundPage = true;
                    } else {
                        page.classList.add('hidden');
                        page.classList.remove('page-fade-in');
                    }
                });
                if(foundPage) toggleMenu();
            };

            const updatePlayPauseIcon = (state) => {
                if (state === 'running') {
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            };
            
            const updateThemeToggleUI = () => {
                if (document.documentElement.classList.contains('dark')) {
                    themeToggle.classList.add('bg-blue-500');
                    themeToggle.classList.remove('bg-gray-300');
                    themeToggleIndicator.classList.add('translate-x-6');
                } else {
                    themeToggle.classList.remove('bg-blue-500');
                    themeToggle.classList.add('bg-gray-300');
                    themeToggleIndicator.classList.remove('translate-x-6');
                }
            };

            const updatePomodoroSliderDisplay = () => {
                 const minutes = pomodoroDurations[pomodoroSlider.value] / 60;
                 pomodoroSliderValue.textContent = `${minutes} min`;
                 if(timerState === 'stopped' && timerMode === 'pomodoro') resetTimer();
            };

            const updateBreakSliderDisplay = () => {
                const minutes = breakDurations[breakSlider.value] / 60;
                breakSliderValue.textContent = `${minutes} min`;
                if(timerState === 'stopped' && timerMode === 'break') resetTimer();
            };
            
            const showAlert = (title, message, actions) => {
                alertTitle.textContent = title;
                alertMessage.textContent = message;
                alertActions.innerHTML = ''; // Clear previous actions
                
                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.textContent = action.text;
                    button.className = action.class || 'flex-1 p-3 rounded-lg font-bold active:opacity-80';
                    button.onclick = () => {
                        alertModal.classList.add('hidden');
                        if(action.callback) action.callback();
                    };
                    alertActions.appendChild(button);
                });
                
                alertModal.classList.remove('hidden');
            };


            // --- TIMER LOGIC ---
            const startTimer = () => {
                if (timerState === 'running') return;
                timerState = 'running';
                updatePlayPauseIcon('running');
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        handleTimerCompletion();
                    }
                }, 1000);
            };

            const pauseTimer = () => {
                if (timerState !== 'running') return;
                clearInterval(timerInterval);
                timerState = 'paused';
                updatePlayPauseIcon('paused');
            };
            
            const startPauseToggle = () => {
                if(timerState === 'running') {
                    pauseTimer();
                } else {
                    startTimer();
                }
            };

            const resetTimer = () => {
                clearInterval(timerInterval);
                timerState = 'stopped';
                if (timerMode === 'pomodoro') {
                    totalTime = timeLeft = pomodoroDurations[pomodoroSlider.value];
                } else {
                    totalTime = timeLeft = breakDurations[breakSlider.value];
                }
                updatePlayPauseIcon('stopped');
                updateTimerDisplay();
            };

            const handleTimerCompletion = () => {
                // Play a subtle notification sound
                new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(3e3).join('123')).play();
                
                if (timerMode === 'pomodoro') {
                    const minutes = pomodoroDurations[pomodoroSlider.value] / 60;
                    const earnedPoints = Math.floor(minutes / 3);
                    points += earnedPoints;
                    updatePointsDisplay();
                    saveSettings();
                    showAlert('Focus Complete!', `You earned ${earnedPoints} points. Time for a break!`, [
                        { text: 'Start Break', class: 'flex-1 p-3 rounded-lg font-bold bg-blue-500 text-white', callback: () => switchMode('break') }
                    ]);
                    switchMode('break', false); // Switch mode but don't auto-start
                } else {
                    showAlert('Break Over!', 'Ready for another focus session?', [
                        { text: 'Start Focus', class: 'flex-1 p-3 rounded-lg font-bold bg-blue-500 text-white', callback: () => switchMode('pomodoro') }
                    ]);
                    switchMode('pomodoro', false); // Switch mode but don't auto-start
                }
            };
            
            const skipTimer = () => {
                showAlert('Skip Session?', `Are you sure you want to skip this ${timerMode} session?`, [
                    { text: 'Cancel', class: 'flex-1 p-3 rounded-lg bg-gray-500/20' },
                    { text: 'Skip', class: 'flex-1 p-3 rounded-lg bg-red-500 text-white', callback: () => {
                        if (timerMode === 'pomodoro') {
                           switchMode('break');
                        } else {
                           switchMode('pomodoro');
                        }
                    }}
                ]);
            };

            const switchMode = (mode, autoStart = true) => {
                timerMode = mode;
                if (mode === 'pomodoro') {
                    timerModeDisplay.textContent = 'Focus';
                } else {
                    timerModeDisplay.textContent = 'Break';
                }
                resetTimer();
                if (autoStart) startTimer();
            };
            

            // --- DATA HANDLING ---
            const exportData = () => {
                const data = localStorage.getItem('cronoTrackSettings');
                if (!data) {
                    showAlert('No Data', 'There is no data to export.', [{text: 'OK', class: 'flex-1 p-3 rounded-lg bg-blue-500 text-white'}]);
                    return;
                }
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `crono-track-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedSettings = JSON.parse(e.target.result);
                        // Basic validation
                        if ('points' in importedSettings && 'theme' in importedSettings) {
                           localStorage.setItem('cronoTrackSettings', e.target.result);
                           loadSettings();
                           resetTimer();
                           updatePointsDisplay();
                           showAlert('Success!', 'Your data has been imported successfully.', [{text: 'Great!', class: 'flex-1 p-3 rounded-lg bg-blue-500 text-white'}]);
                        } else {
                           throw new Error('Invalid file format.');
                        }
                    } catch (error) {
                        showAlert('Import Failed', 'The selected file is not a valid CronoTrack backup.', [{text: 'OK', class: 'flex-1 p-3 rounded-lg bg-red-500 text-white'}]);
                    }
                };
                reader.readAsText(file);
                // Reset file input to allow re-importing the same file
                importFileInput.value = '';
            };


            // --- EVENT LISTENERS ---
            menuBtn.addEventListener('click', toggleMenu);
            closeMenuBtn.addEventListener('click', toggleMenu);
            backdrop.addEventListener('click', toggleMenu);

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(e.target.dataset.page);
                });
            });
            
            startPauseBtn.addEventListener('click', startPauseToggle);
            resetBtn.addEventListener('click', resetTimer);
            skipBtn.addEventListener('click', skipTimer);

            pomodoroSlider.addEventListener('input', updatePomodoroSliderDisplay);
            pomodoroSlider.addEventListener('change', saveSettings);
            breakSlider.addEventListener('input', updateBreakSliderDisplay);
            breakSlider.addEventListener('change', saveSettings);
            
            // Settings listeners
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                updateThemeToggleUI();
                saveSettings();
            });
            
            textSizeSlider.addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--font-scale', e.target.value);
            });
            textSizeSlider.addEventListener('change', (e) => {
                document.documentElement.style.setProperty('--font-scale', e.target.value);
                saveSettings();
            });

            // Data listeners
            resetAppBtn.addEventListener('click', () => {
                 showAlert('Reset App?', 'All your points and settings will be permanently deleted. This cannot be undone.', [
                    { text: 'Cancel', class: 'flex-1 p-3 rounded-lg bg-gray-500/20' },
                    { text: 'Reset', class: 'flex-1 p-3 rounded-lg bg-red-500 text-white', callback: resetAppSettings}
                ]);
            });
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importData);

            // --- RUN APP ---
            init();
        });
    </script>
</body>
</html>

