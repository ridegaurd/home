<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Konsolo Mobile Editor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* A clean, mobile-first dark design system */
        html, body {
            overscroll-behavior: none;
            font-family: 'Inter', sans-serif;
            color: #e2e8f0; /* Light text for dark background */
            background-color: #0f172a; /* Slate 900 */
            transition: background-color 0.3s ease;
        }
        :root {
            --accent-color: #f97316;
        }
        
        /* EDITOR CORE STYLING */
        #editor {
            font-family: 'Fira Code', monospace;
            tab-size: 2;
            line-height: 1.5rem;
            -webkit-text-size-adjust: 100%;
            background-color: #1e293b; /* Slate 800 */
            color: #e2e8f0;
            caret-color: #f97316;
            transition: all 0.3s ease;
            width: 100%; 
            height: 100%;
            padding: 1rem;
            resize: none;
            border: 0;
            outline: none;
        }
        
        /* Quick Action Bar Styling */
        #quickActionBar {
            background-color: #334155; /* Slate 700 */
            border-top: 1px solid #475569;
        }
        .quick-action-btn {
            background-color: #475569; /* Slate 600 */
            color: #f8fafc;
        }
        .quick-action-btn:active {
            background-color: #64748b; /* Slate 500 */
        }

        /* PANEL TRANSITIONS */
        .panel-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms ease-out, transform 300ms ease-out;
        }
        .panel-exit-active {
            opacity: 0;
            transform: translateY(100%);
            transition: opacity 300ms ease-in, transform 300ms ease-in;
        }
        
        /* --- Snippet Carousel Styling --- */
        #dropletsList {
            overflow-x: scroll;
            scroll-snap-type: x mandatory;
            padding: 1rem 0; 
            align-items: stretch;
            height: 100%; 
            display: flex;
        }
        .snippet-card-wrapper {
            scroll-snap-align: center;
            max-height: 85vh; 
            margin-left: 1rem; 
            flex-shrink: 0; 
            width: 80vw;
            max-width: 320px;
            height: 100%; 
            display: flex;
        }
        .snippet-card-wrapper:last-child {
            margin-right: 1rem; 
        }
        .snippet-card {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            background-color: #1e293b; /* Dark Card Background */
            border-color: #f97316;
        }
        .snippet-card-preview {
            width: 100%;
            padding-bottom: 75%; 
            position: relative; 
            overflow: hidden;
            flex-shrink: 0; 
            background-color: white; 
            border-top: 1px solid #334155; 
        }
        .snippet-card-preview iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            transform: scale(0.5) translate(-25%, -25%); 
            transform-origin: top left;
            pointer-events: none;
            background-color: white;
        }
        /* --- Snippet Carousel Styling END --- */

        .toolbar-btn.active { color: var(--accent-color); }
        .toolbar-btn { color: #64748b; }
        .fullscreen-preview { 
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 50;
            display: flex !important; 
            flex-direction: column;
        }
        .toolbar-hidden { display: none !important; }
        
        /* Slim Bar Visibility and Style */
        #slimBar { 
            background-color: rgba(30, 41, 59, 0.9); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0; 
            z-index: 60; 
        }
        #slimBar button svg { color: #e2e8f0; } 

        /* Dark Mode UI Elements (Consistent Styling) */
        #topBar { background-color: #1e293b; border-color: #334155; }
        #bottomNav { background-color: rgba(30, 41, 59, 0.9); border-color: #334155; }
        #homeScreen .bg-white { background-color: #1e293b; color: #e2e8f0; }
        .code-snippet-box { background-color: #0f172a; border: 1px solid #334155; }
        #homeScreen button { color: #e2e8f0; }
        #goToDropletsBtn { background-color: #334155; }
        #goToDropletsBtn:hover { background-color: #475569; }
        
        #dropletsPanel { background-color: #0f172a; }
        #dropletsPanel header { border-color: #334155; }
        #dropletsPanel button { color: #e2e8f0; }
        #templateSelect { background-color: #334155; border-color: #475569; color: #e2e8f0; }
        #loadTemplateBtn { background-color: #f97316; color: white; }
        
        #saveModalContent { background-color: #1e293b; }
        #snippetTitleInput { background-color: #334155; border-color: #475569; color: #e2e8f0; }
        #contextMenuContent { background-color: #1e293b; }
        #contextMenuContent button { color: #e2e8f0; }
        #contextMenuContent button:hover { background-color: #334155; }
        .text-red-600 { color: #f87171; }
        
        .snippet-card .text-gray-900 { color: #e2e8f0; } 
        
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #64748b; border-radius: 3px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden antialiased">

    <div id="homeScreen" class="h-full w-full flex flex-col items-center justify-center p-8 text-center transition-all duration-300">
        <div class="mb-10 w-full max-w-sm p-6 bg-white rounded-xl shadow-2xl transition-all duration-300">
            <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500">Konsolo</h1>
            <p class="mt-2 text-xl font-medium text-gray-700">Code Snippets on the Go.</p>
            
            <div class="code-snippet-box p-3 mt-6 text-left text-xs font-mono select-none overflow-x-auto rounded-lg">
                <span class="text-orange-400">&lt;div</span> <span class="text-cyan-400">class</span>=<span class="text-yellow-400">"konsolo-app"</span><span class="text-orange-400">&gt;</span><br>
                <span class="text-slate-500 ml-3">// Write your HTML here</span><br>
                <span class="text-orange-400 ml-3">&lt;h1&gt;</span>Hello Mobile Coder<span class="text-orange-400">&lt;/h1&gt;</span><br>
                <span class="text-orange-400">&lt;/div&gt;</span>
            </div>
            
            <div class="w-full space-y-4 mt-8">
                <button id="goToEditorBtn" class="w-full bg-orange-500 text-white font-semibold py-4 rounded-lg shadow-xl shadow-orange-500/30 hover:bg-orange-600 focus:outline-none focus:ring-4 focus:ring-orange-500/50 transition-all text-lg">
                    Launch Editor
                </button>
                <button id="goToDropletsBtn" class="w-full bg-gray-200 text-gray-800 font-semibold py-4 rounded-lg hover:bg-gray-300 transition-all text-lg">
                    View Snippets
                </button>
            </div>
        </div>
    </div>

    <div id="appContainer" class="h-full w-full flex-col hidden transition-all duration-300">
        <header id="topBar" class="flex-shrink-0 z-10 p-3 border-b flex items-center justify-between transition-all duration-300">
            <button id="homeBtn" class="p-2 rounded-md hover:bg-gray-700 transition-colors">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </button>
            <h1 id="titleDisplay" class="text-base font-bold truncate px-2 text-gray-200">Konsolo Editor</h1>
            <button id="actionBtn" class="text-sm font-semibold bg-orange-500 text-white px-3 py-1.5 rounded-md hover:bg-orange-600 transition-colors">Save</button>
        </header>
        
        <div id="quickActionBar" class="flex-shrink-0 w-full flex justify-start overflow-x-auto p-1.5 whitespace-nowrap hidden">
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">&lt;</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">&gt;</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">/</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">&amp;</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">:</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">;</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">|</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">Tab</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">"</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">'</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">{</button>
            <button class="quick-action-btn px-3 py-1.5 m-0.5 rounded-lg text-sm font-mono">(</button>
        </div>

        <main class="flex-grow relative overflow-hidden pb-16">
            <div id="editorWrapper" class="h-full">
                <textarea id="editor" spellcheck="false" autocapitalize="off" autocomplete="off" autocorrect="off"></textarea>
            </div>
            
            <div id="previewContainer" class="w-full h-full bg-white hidden relative">
                <iframe id="preview" class="w-full h-full" sandbox="allow-scripts allow-same-origin"></iframe>
                <button id="fullscreenBtn" class="absolute top-2 right-2 p-2 bg-gray-800/70 backdrop-blur rounded-md shadow hover:bg-gray-700 transition-all z-20">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path></svg>
                </button>
            </div>
        </main>

        <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 backdrop-blur-sm border-t flex justify-around items-center z-30 transition-all duration-300">
            <button id="editBtn" class="toolbar-btn flex-1 p-2 text-center active transition-colors">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                <span class="text-xs font-medium mt-1">Editor</span>
            </button>
            <button id="previewBtn" class="toolbar-btn flex-1 p-2 text-center transition-colors">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                <span class="text-xs font-medium mt-1">Preview</span>
            </button>
            <button id="dropletsBtn" class="toolbar-btn flex-1 p-2 text-center transition-colors">
                <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                <span class="text-xs font-medium mt-1">Snippets</span>
            </button>
        </nav>
    </div>

    <nav id="slimBar" class="fixed bottom-0 left-0 right-0 h-9 flex items-center justify-between px-4 text-xs font-medium z-55" style="display:none;">
        <button id="slimExitBtn" class="flex items-center space-x-1 py-1 px-2 rounded hover:bg-gray-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Exit</span>
        </button>
        <button id="slimReloadBtn" class="py-1 px-2 rounded hover:bg-gray-700 transition-colors">Reload</button>
    </nav>

    <div id="dropletsPanel" class="fixed inset-0 z-40 transform translate-y-full opacity-0 flex flex-col transition-all duration-300 ease-in-out">
        <header class="p-4 border-b flex-shrink-0 flex items-center justify-between gap-4">
            <h2 class="text-lg font-bold">Your Konsolo Snippets</h2>
             <div class="flex items-center gap-2">
                <button id="importBtn" class="text-sm font-semibold px-3 py-1.5 rounded-md hover:bg-gray-700 transition-colors">Import</button>
                <input type="file" id="importFile" accept=".kkode" class="hidden">
                <button id="newDropletBtn" class="text-sm font-semibold text-orange-400 px-3 py-1.5 rounded-md hover:bg-gray-700 transition-colors">New</button>
                <button id="closeDropletsBtn" class="text-gray-400 hover:text-gray-200 text-2xl transition-colors">&times;</button>
            </div>
        </header>
        <div id="dropletsList" class="flex-grow overflow-x-auto p-4 custom-scrollbar flex items-stretch gap-4">
            </div>
        
        <div class="flex-shrink-0 p-4 border-t bg-gray-800">
            <label for="templateSelect" class="block text-sm font-medium text-gray-400 mb-2">Start from a Template:</label>
            <select id="templateSelect" class="w-full px-3 py-2 border rounded-md focus:ring-orange-500 focus:border-orange-500 transition-colors">
                <option value="default">Default Konsolo</option>
                <option value="tailwind">Tailwind CSS Starter</option>
                <option value="skeleton">Minimal HTML Skeleton</option>
                </select>
            <button id="loadTemplateBtn" class="w-full mt-3 font-semibold py-2 rounded-md transition-colors">Load Template into Editor</button>
        </div>
    </div>
    
    <div id="saveModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div id="saveModalContent" class="rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4 transform scale-95 opacity-0 transition-all duration-300">
            <h3 id="saveModalTitle" class="text-lg font-bold">Save Current Snippet</h3>
            <input type="text" id="snippetTitleInput" placeholder="Snippet Title (e.g., 'Hero Section')" class="w-full px-4 py-2 border rounded-md focus:ring-orange-500 focus:border-orange-500 transition-colors">
            <div class="flex justify-end space-x-3">
                <button id="cancelSaveBtn" class="px-4 py-2 text-gray-400 hover:bg-gray-700 rounded-md transition-colors">Cancel</button>
                <button id="confirmSaveBtn" class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-md hover:bg-orange-600 transition-colors">Save Snippet</button>
            </div>
        </div>
    </div>
    
    <div id="contextMenuModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div id="contextMenuContent" class="rounded-lg shadow-xl w-full max-w-xs p-2 transform scale-95 opacity-0 transition-all duration-300">
            <h3 class="text-sm font-semibold text-gray-400 p-2 border-b border-gray-700">Snippet Options</h3>
            <button id="contextLoadBtn" data-index="" class="w-full text-left p-3 flex items-center space-x-2 hover:bg-gray-700 rounded-md transition-colors">Load into Editor</button>
            <button id="contextRenameBtn" data-index="" class="w-full text-left p-3 flex items-center space-x-2 hover:bg-gray-700 rounded-md transition-colors">Rename Snippet</button>
            <button id="contextAsTemplateBtn" data-index="" class="w-full text-left p-3 flex items-center space-x-2 text-green-400 hover:bg-gray-700 rounded-md transition-colors">Save as Template</button>
            <button id="contextExportBtn" data-index="" class="w-full text-left p-3 flex items-center space-x-2 hover:bg-gray-700 rounded-md transition-colors">Export (.kkode)</button>
            <button id="contextDeleteBtn" data-index="" class="w-full text-left p-3 flex items-center space-x-2 text-red-600 hover:bg-gray-700 rounded-md transition-colors">Delete Snippet</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white py-2 px-5 rounded-full shadow-lg text-sm opacity-0 transition-all duration-200 z-50">
        Snippet saved!
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements & State ---
            const editor = document.getElementById('editor');
            const editorWrapper = document.getElementById('editorWrapper');
            const preview = document.getElementById('preview');
            const previewContainer = document.getElementById('previewContainer');
            const dropletsPanel = document.getElementById('dropletsPanel');
            const dropletsList = document.getElementById('dropletsList');
            const toast = document.getElementById('toast');
            const topBar = document.getElementById('topBar');
            const bottomNav = document.getElementById('bottomNav');
            const slimBar = document.getElementById('slimBar'); 
            const quickActionBar = document.getElementById('quickActionBar');
            const titleDisplay = document.getElementById('titleDisplay');
            const loadTemplateBtn = document.getElementById('loadTemplateBtn');
            const templateSelect = document.getElementById('templateSelect');
            const goToEditorBtn = document.getElementById('goToEditorBtn');

            // Modals
            const saveModal = document.getElementById('saveModal');
            const saveModalContent = document.getElementById('saveModalContent');
            const saveModalTitle = document.getElementById('saveModalTitle');
            const snippetTitleInput = document.getElementById('snippetTitleInput');
            const contextMenuModal = document.getElementById('contextMenuModal');
            const contextMenuContent = document.getElementById('contextMenuContent');

            // Buttons
            const actionBtn = document.getElementById('actionBtn'); 
            const editBtn = document.getElementById('editBtn');
            const previewBtn = document.getElementById('previewBtn');
            const dropletsBtn = document.getElementById('dropletsBtn');
            const slimExitBtn = document.getElementById('slimExitBtn'); 
            const slimReloadBtn = document.getElementById('slimReloadBtn'); 
            const navButtons = [editBtn, previewBtn, dropletsBtn];

            let droplets = [];
            let customTemplates = [];
            let currentSnippetIndex = null; 
            let longPressTimer = null;
            const LONG_PRESS_DURATION_CONTEXT = 700; 

            // Base templates are now the source of truth for new files
            const baseTemplates = {
                default: `<!DOCTYPE html>
<html>
<head>
  <title>Default Konsolo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background-color: #f0f0f0; color: #333; padding: 20px;}
  </style>
</head>
<body>
  <h1>Hello Mobile Coder</h1>
  <p>Start coding your mobile project!</p>
</body>
</html>`,
                // NOTE: Tailwind template still uses an external CDN link, which may fail in strict WebViews. 
                // However, the main app's UI is already styled via the *inlined* Tailwind CDN script at the top.
                tailwind: `<!DOCTYPE html>
<html>
<head>
  <title>Tailwind Starter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"><\/script> 
</head>
<body class="bg-gray-900 text-white flex h-screen items-center justify-center">
  <div class="text-center p-8 bg-slate-800 rounded-lg shadow-xl">
    <h1 class="text-5xl font-extrabold text-teal-400">Tailwind Droplet</h1>
    <p class="mt-4 text-lg">A responsive, functional snippet.</p>
    <button class="mt-6 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">Click Me</button>
  </div>
</body>
</html>`,
                skeleton: `<!DOCTYPE html>
<html>
<head>
  <title>Minimal Skeleton</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  </body>
</html>`
            };
            
            // --- Core Functions ---
            const updateTitle = () => {
                const match = editor.value.match(/<title>(.*?)<\/title>/i);
                if (currentSnippetIndex !== null) {
                    titleDisplay.textContent = droplets[currentSnippetIndex].title;
                } else if (match && match[1].trim()) {
                    titleDisplay.textContent = match[1].trim();
                } else {
                    titleDisplay.textContent = 'Untitled Snippet';
                }
            };

            const updatePreview = () => { 
                preview.srcdoc = editor.value; 
                updateTitle(); 
            };

            const setActiveButton = (activeBtn) => {
                navButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                activeBtn.classList.add('active');
            };

            const updateActionButton = () => {
                const isUpdate = currentSnippetIndex !== null;
                actionBtn.textContent = isUpdate ? 'Update' : 'Save';
                actionBtn.classList.toggle('bg-green-600', isUpdate);
                actionBtn.classList.toggle('hover:bg-green-700', isUpdate);
                actionBtn.classList.toggle('bg-orange-500', !isUpdate);
                actionBtn.classList.toggle('hover:bg-orange-600', !isUpdate);
            };
            
            const showToast = (message) => {
                toast.textContent = message;
                toast.classList.add('toast-enter-active');
                toast.classList.remove('opacity-0', 'toast-exit-active');

                setTimeout(() => {
                    toast.classList.remove('toast-enter-active');
                    toast.classList.add('toast-exit-active');
                    setTimeout(() => {
                        toast.classList.add('opacity-0');
                    }, 200);
                }, 2000);
            };

            const showModal = (modal, content) => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const hideModal = (modal, content, callback) => {
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.remove('flex');
                    modal.classList.add('hidden');
                    if(callback) callback();
                }, 300);
            };

            // --- Storage and Rendering ---
            const saveDropletsToStorage = () => localStorage.setItem('html_droplets_v2', JSON.stringify(droplets));
            const saveTemplatesToStorage = () => localStorage.setItem('custom_templates_v1', JSON.stringify(customTemplates));
            
            const loadDropletsFromStorage = () => {
                const data = localStorage.getItem('html_droplets_v2');
                droplets = data ? JSON.parse(data) : [];
                droplets.forEach((d, i) => {
                    if (!d.title) d.title = `Untitled Snippet #${droplets.length - i}`;
                });
            };

            const loadTemplatesFromStorage = () => {
                const data = localStorage.getItem('custom_templates_v1');
                customTemplates = data ? JSON.parse(data) : [];
            };

            const renderTemplateOptions = () => {
                const existingOptions = templateSelect.querySelectorAll('option:not([value="default"]):not([value="tailwind"]):not([value="skeleton"])');
                existingOptions.forEach(opt => opt.remove());

                customTemplates.forEach((template, index) => {
                    const opt = document.createElement('option');
                    opt.value = `custom_${index}`;
                    opt.textContent = `[Template] ${template.title}`;
                    templateSelect.appendChild(opt);
                });
            };
            
            const renderDroplets = () => {
                dropletsList.innerHTML = '';
                if (droplets.length === 0) {
                    dropletsList.innerHTML = `<p class="text-gray-500 text-center p-4 w-full">No snippets saved yet. Tap 'New' or load a template!</p>`;
                    return;
                }
                
                [...droplets].reverse().forEach((droplet, reversedIndex) => {
                    const originalIndex = droplets.length - 1 - reversedIndex;
                    const el = document.createElement('div');
                    el.className = 'snippet-card-wrapper flex-shrink-0 w-[80%] sm:w-80 h-full cursor-pointer snap-center';
                    
                    el.innerHTML = `
                        <div data-index="${originalIndex}" class="snippet-card h-full rounded-xl shadow-xl border-t-4 overflow-hidden flex flex-col transition-all duration-300 hover:scale-[1.02]">
                            <div class="p-3 flex-shrink-0">
                                <p class="font-bold text-base truncate text-gray-200">${droplet.title}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(droplet.id).toLocaleDateString()}</p>
                            </div>
                            <div class="flex-grow snippet-card-preview">
                                <iframe srcdoc="${droplet.html.replace(/"/g, '&quot;')}" class="w-full h-full border-0 bg-white"></iframe>
                            </div>
                        </div>
                    `;
                    dropletsList.appendChild(el);
                });
            };

            // --- UI/Navigation Control ---
            const enterFullscreen = () => {
                topBar.classList.add('toolbar-hidden');
                bottomNav.classList.add('toolbar-hidden');
                
                previewContainer.classList.add('fullscreen-preview');
                
                document.getElementById('fullscreenBtn').classList.add('hidden');
                slimBar.style.display = 'flex';
                quickActionBar.classList.add('hidden');
                
                preview.style.height = `calc(100% - ${slimBar.offsetHeight}px)`;
            };

            const exitFullscreen = () => {
                topBar.classList.remove('toolbar-hidden');
                bottomNav.classList.remove('toolbar-hidden');
                
                previewContainer.classList.remove('fullscreen-preview');
                
                document.getElementById('fullscreenBtn').classList.remove('hidden');
                slimBar.style.display = 'none';
                preview.style.height = '100%';
            };
            
            const showDroplets = () => {
                renderDroplets();
                renderTemplateOptions();
                dropletsPanel.classList.remove('translate-y-full', 'opacity-0', 'panel-exit-active');
                dropletsPanel.classList.add('panel-enter-active');
                exitFullscreen();
            };
            
            const hideDroplets = () => {
                dropletsPanel.classList.remove('panel-enter-active');
                dropletsPanel.classList.add('panel-exit-active');
                setTimeout(() => {
                    dropletsPanel.classList.add('translate-y-full', 'opacity-0');
                    dropletsPanel.classList.remove('panel-exit-active');
                }, 300);
            };
            
            // --- Save/Update & Rename Logic ---
            const promptSaveAsTemplate = (index) => {
                const snippet = droplets[index];
                saveModalTitle.textContent = 'Save as Custom Template';
                snippetTitleInput.value = snippet.title;
                showModal(saveModal, saveModalContent);
                
                document.getElementById('confirmSaveBtn').textContent = "Save Template";
                document.getElementById('confirmSaveBtn').onclick = () => {
                    const templateTitle = snippetTitleInput.value.trim() || `Untitled Template`;
                    customTemplates.push({ id: Date.now(), title: templateTitle, html: snippet.html });
                    saveTemplatesToStorage();
                    hideModal(saveModal, saveModalContent, () => {
                        showToast(`Saved '${templateTitle}' as a new template!`);
                        renderTemplateOptions();
                    });
                    
                    document.getElementById('confirmSaveBtn').onclick = performSaveOrUpdate;
                    document.getElementById('confirmSaveBtn').textContent = (currentSnippetIndex !== null) ? "Update Snippet" : "Save Snippet";
                };
            };

            const performSaveOrUpdate = () => {
                const code = editor.value.trim();
                const title = snippetTitleInput.value.trim() || `Untitled Snippet`;

                if (currentSnippetIndex !== null) {
                    droplets[currentSnippetIndex].title = title;
                    droplets[currentSnippetIndex].html = code;
                    saveDropletsToStorage();
                    hideModal(saveModal, saveModalContent, () => {
                        showToast(`'${title}' updated.`);
                    });
                } else {
                    droplets.unshift({ id: Date.now(), title: title, html: code });
                    currentSnippetIndex = 0; 
                    saveDropletsToStorage();
                    hideModal(saveModal, saveModalContent, () => {
                        showToast(`'${title}' saved!`);
                    });
                }
                updateActionButton();
                updateTitle();
            };
            
            // --- Editor Feature Logic ---
            const handleEditorInput = (e) => {
                updatePreview();

                const text = editor.value;
                const caretPos = editor.selectionStart;

                const autoCloseMap = {
                    '(': ')', '[': ']', '{': '}', '"': '"', "'": "'", '<': '>'
                };

                const lastChar = text.substring(caretPos - 1, caretPos);
                if (autoCloseMap[lastChar] && text.substring(caretPos, caretPos + 1) !== autoCloseMap[lastChar]) {
                    const closingChar = autoCloseMap[lastChar];
                    editor.value = text.substring(0, caretPos) + closingChar + text.substring(caretPos);
                    editor.selectionStart = editor.selectionEnd = caretPos;
                }
            };
            
            const handleQuickAction = (char) => {
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                let newText = char;
                let newPos = start + newText.length;
                
                if (char === 'Tab') {
                    newText = '  '; 
                } else if (char === '&') {
                    newText = '&amp;';
                    newPos = start + 1; 
                } else if (char === '<') {
                    newText = '<>'; 
                    newPos = start + 1;
                }

                editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = newPos;
                editor.focus();
                updatePreview();
            };

            // --- Event Listeners ---
            document.getElementById('actionBtn').addEventListener('click', () => {
                document.getElementById('confirmSaveBtn').onclick = performSaveOrUpdate;
                document.getElementById('confirmSaveBtn').textContent = (currentSnippetIndex !== null) ? "Update Snippet" : "Save Snippet";
                
                const code = editor.value.trim();
                if (!code) {
                    showToast('Editor is empty! Cannot save or update.');
                    return;
                }
                
                const isUpdate = currentSnippetIndex !== null;
                saveModalTitle.textContent = isUpdate ? 'Update Snippet' : 'Save New Snippet';
                
                if (isUpdate) {
                    snippetTitleInput.value = droplets[currentSnippetIndex].title;
                } else {
                    const defaultTitle = editor.value.match(/<title>(.*?)<\/title>/i)
                        ? editor.value.match(/<title>(.*?)<\/title>/i)[1].trim()
                        : `New Snippet ${droplets.length + 1}`;
                    snippetTitleInput.value = defaultTitle;
                }
                showModal(saveModal, saveModalContent);
            });
            
            document.getElementById('cancelSaveBtn').addEventListener('click', () => { hideModal(saveModal, saveModalContent); });
            document.getElementById('fullscreenBtn').addEventListener('click', enterFullscreen);
            
            // Slim Navbar Functionality
            slimExitBtn.addEventListener('click', () => { 
                exitFullscreen(); 
                editBtn.click(); 
            });
            slimReloadBtn.addEventListener('click', () => { 
                updatePreview(); 
                showToast('Preview Reloaded'); 
            });

            document.getElementById('closeDropletsBtn').addEventListener('click', hideDroplets);

            editor.addEventListener('input', handleEditorInput);
            
            editor.addEventListener('focus', () => quickActionBar.classList.remove('hidden'));
            editor.addEventListener('blur', () => {
                if (saveModal.classList.contains('hidden') && contextMenuModal.classList.contains('hidden')) {
                    setTimeout(() => quickActionBar.classList.add('hidden'), 100); 
                }
            });
            
            quickActionBar.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    handleQuickAction(e.target.textContent);
                });
            });
            
            loadTemplateBtn.addEventListener('click', () => {
                const templateKey = templateSelect.value;
                
                let htmlToLoad;
                if (baseTemplates[templateKey]) {
                    htmlToLoad = baseTemplates[templateKey];
                } else if (templateKey.startsWith('custom_')) {
                    const index = parseInt(templateKey.split('_')[1]);
                    htmlToLoad = customTemplates[index].html;
                }

                editor.value = htmlToLoad;
                currentSnippetIndex = null;
                updatePreview();
                updateActionButton();
                hideDroplets();
                editBtn.click();
                showToast('Template loaded.');
            });

            // --- Navigation Handlers ---
            document.getElementById('editBtn').addEventListener('click', () => {
                exitFullscreen();
                editorWrapper.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                setActiveButton(editBtn);
            });
            
            document.getElementById('previewBtn').addEventListener('click', () => {
                exitFullscreen();
                updatePreview();
                editorWrapper.classList.add('hidden');
                previewContainer.classList.remove('hidden');
                setActiveButton(previewBtn);
            });
            
            document.getElementById('dropletsBtn').addEventListener('click', () => {
                hideModal(contextMenuModal, contextMenuContent);
                showDroplets();
                setActiveButton(dropletsBtn);
            });
            
            document.getElementById('newDropletBtn').addEventListener('click', () => {
                editor.value = baseTemplates.default;
                currentSnippetIndex = null;
                updatePreview();
                updateActionButton();
                hideDroplets();
                editBtn.click();
            });

            // Home Screen to Editor Transition
            document.getElementById('goToEditorBtn').addEventListener('click', () => {
                document.getElementById('homeScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('flex');
                editBtn.click(); 
            });
            
            document.getElementById('goToDropletsBtn').addEventListener('click', () => {
                document.getElementById('homeScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('flex');
                showDroplets();
                setActiveButton(dropletsBtn);
            });
            
            document.getElementById('homeBtn').addEventListener('click', () => {
                document.getElementById('homeScreen').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('flex');
                exitFullscreen();
            });
            
            // --- Context Menu Handlers (Tap/Long Press) ---
            document.getElementById('contextLoadBtn').addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                editor.value = droplets[index].html;
                currentSnippetIndex = index;
                updatePreview();
                updateActionButton();
                hideModal(contextMenuModal, contextMenuContent);
                hideDroplets();
                editBtn.click(); 
                showToast(`Loaded '${droplets[index].title}'`);
            });
            document.getElementById('contextRenameBtn').addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                const snippet = droplets[index];
                saveModalTitle.textContent = 'Rename Snippet';
                snippetTitleInput.value = snippet.title;
                showModal(saveModal, saveModalContent);
                
                document.getElementById('confirmSaveBtn').textContent = "Confirm Rename";
                document.getElementById('confirmSaveBtn').onclick = () => {
                    const newTitle = snippetTitleInput.value.trim() || `Untitled Snippet`;
                    droplets[index].title = newTitle;
                    saveDropletsToStorage();
                    hideModal(saveModal, saveModalContent, () => {
                        showToast(`Snippet renamed to '${newTitle}'`);
                        renderDroplets();
                        if (currentSnippetIndex === index) updateTitle();
                    });
                    document.getElementById('confirmSaveBtn').onclick = performSaveOrUpdate;
                    document.getElementById('confirmSaveBtn').textContent = (currentSnippetIndex !== null) ? "Update Snippet" : "Save Snippet";
                };
                hideModal(contextMenuModal, contextMenuContent);
            });
            
            document.getElementById('contextAsTemplateBtn').addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                hideModal(contextMenuModal, contextMenuContent, () => promptSaveAsTemplate(index));
            });

            document.getElementById('contextDeleteBtn').addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                const title = droplets[index].title;
                droplets.splice(index, 1);
                saveDropletsToStorage();
                
                if (currentSnippetIndex === index) {
                    editor.value = baseTemplates.default;
                    currentSnippetIndex = null;
                    updatePreview();
                    updateActionButton();
                } else if (currentSnippetIndex !== null && currentSnippetIndex > index) {
                    currentSnippetIndex--;
                }

                hideModal(contextMenuModal, contextMenuContent, () => {
                    showToast(`Deleted snippet '${title}'`);
                    renderDroplets();
                });
            });

            // Droplets Card Interaction (Tap/Long Press)
            dropletsList.addEventListener('mousedown', handleCardStart);
            dropletsList.addEventListener('touchstart', handleCardStart);
            dropletsList.addEventListener('mouseup', handleCardEnd);
            dropletsList.addEventListener('touchend', handleCardEnd);
            
            function handleCardStart(e) {
                const card = e.target.closest('.snippet-card');
                if (card) {
                    e.preventDefault();
                    const index = parseInt(card.dataset.index);
                    longPressTimer = setTimeout(() => {
                        longPressTimer = null;
                        
                        document.getElementById('contextLoadBtn').dataset.index = index;
                        document.getElementById('contextRenameBtn').dataset.index = index;
                        document.getElementById('contextAsTemplateBtn').dataset.index = index;
                        document.getElementById('contextExportBtn').dataset.index = index;
                        document.getElementById('contextDeleteBtn').dataset.index = index;

                        hideDroplets();
                        showModal(contextMenuModal, contextMenuContent);
                    }, LONG_PRESS_DURATION_CONTEXT);
                }
            }

            function handleCardEnd(e) {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                    
                    const card = e.target.closest('.snippet-card');
                    if (card) {
                        const index = parseInt(card.dataset.index);
                        
                        editor.value = droplets[index].html;
                        currentSnippetIndex = index;
                        updatePreview();
                        updateActionButton();
                        
                        hideDroplets();
                        
                        editorWrapper.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        setActiveButton(previewBtn);
                        
                        // A quick tap loads the snippet and shows the fullscreen preview
                        enterFullscreen(); 
                    }
                }
            }
            // Add handler for scroll/move to cancel long press
            dropletsList.addEventListener('scroll', handleCardMove);
            dropletsList.addEventListener('touchmove', handleCardMove);
            function handleCardMove() {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
            // --- Initialization ---
            const init = () => {
                loadDropletsFromStorage();
                loadTemplatesFromStorage();
                
                if (droplets.length > 0) {
                    editor.value = droplets[0].html;
                    currentSnippetIndex = 0;
                } else {
                    editor.value = baseTemplates.default;
                    currentSnippetIndex = null;
                }
                
                updatePreview();
                updateActionButton();
                setActiveButton(editBtn);
                previewContainer.classList.add('hidden');
                editorWrapper.classList.remove('hidden');
                renderTemplateOptions(); 
            };

            init();
        });
    </script>
</body>
</html>
