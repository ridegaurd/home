<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noteworthy: Cloud Notes App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* ========================================================================= */
        /* --- COPY/PASTE THE ENTIRE CSS BLOCK FROM THE PREVIOUS RESPONSE HERE --- */
        /* ========================================================================= */
        :root {
            /* Color Palette: Modern and Clean */
            --color-bg-light: #f4f6f9; /* Off-white, airy background */
            --color-paper-light: #ffffff;
            --color-text-light: #181c20;
            --color-accent: #2e7d32; /* Deep Green for a calming, focused feel */
            --color-accent-hover: #1b5e20;
            --color-sidebar-bg-light: #e9ecef;
            --color-secondary-text: #6c757d;
            
            --color-bg-dark: #121212; /* True black */
            --color-paper-dark: #1e1e1e; /* Dark gray for notes */
            --color-text-dark: #f0f0f0;
            --color-sidebar-bg-dark: #2c2c2c;
            
            --border-radius: 8px;
            --padding-lg: 20px;
            --transition-time: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color var(--transition-time), color var(--transition-time), border-color var(--transition-time), box-shadow var(--transition-time); 
        }

        /* --- MODE VARIABLES --- */
        .light-mode {
            --color-bg: var(--color-bg-light);
            --color-paper: var(--color-paper-light);
            --color-text: var(--color-text-light);
            --color-sidebar-bg: var(--color-sidebar-bg-light);
        }

        .dark-mode {
            --color-bg: var(--color-bg-dark);
            --color-paper: var(--color-paper-dark);
            --color-text: var(--color-text-dark);
            --color-sidebar-bg: var(--color-sidebar-bg-dark);
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            height: 100vh;
            display: flex;
            overflow: hidden;
            align-items: center;
            justify-content: center;
        }

        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: absolute;
        }

        /* --- HOME SCREEN (AUTH) STYLES --- */
        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }

        .auth-container {
            background: var(--color-paper);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 400px;
            text-align: center;
        }

        .auth-container h1 {
            font-size: 3em;
            color: var(--color-accent);
            margin-bottom: 30px;
            font-weight: 800;
        }

        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 15px;
            border: 1px solid var(--color-sidebar-bg);
            border-radius: var(--border-radius);
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-button:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .google-auth {
            background-color: var(--color-paper);
            color: var(--color-text);
        }
        .google-auth i {
            color: #db4437; /* Google red */
            margin-right: 10px;
        }

        .email-auth {
            background-color: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
        }
        .email-auth i {
            margin-right: 10px;
        }

        .separator {
            margin: 20px 0;
            color: var(--color-secondary-text);
            position: relative;
        }
        .separator::before, .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: var(--color-sidebar-bg);
        }
        .separator::before { left: 0; }
        .separator::after { right: 0; }
        
        /* Limited Account Hint */
        .limited-hint {
            font-size: 0.9em;
            color: var(--color-secondary-text);
            margin-top: -10px;
            margin-bottom: 20px;
        }


        /* --- MAIN APP STYLES (Keep from previous version, adapted for hidden state) --- */
        #sidebar {
            width: 320px;
            background-color: var(--color-sidebar-bg);
            border-right: 1px solid var(--color-bg);
            display: flex;
            flex-direction: column;
            padding: var(--padding-lg);
            flex-shrink: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--padding-lg);
        }

        .sidebar-header h2 {
            font-weight: 700;
            color: var(--color-accent);
        }
        
        #toggle-mode, .sidebar-action-btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        #toggle-mode:hover, .sidebar-action-btn:hover {
            background: var(--color-accent-hover);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: var(--color-paper);
            border-radius: var(--border-radius);
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
        }
        .search-box:focus-within {
             border-color: var(--color-accent);
        }
        .search-box input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--color-text);
            outline: none;
            margin-left: 10px;
        }
        .search-box i { color: var(--color-secondary-text); }
        .search-box:focus-within i { color: var(--color-accent); }

        #notes-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
        }

        .note-item {
            padding: 12px 15px; 
            margin-bottom: 8px;
            border-radius: var(--border-radius);
            cursor: pointer;
            background-color: transparent;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .note-item:hover {
            background-color: var(--color-paper);
        }
        .note-item.active {
            background-color: var(--color-paper);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--color-accent);
        }
        .note-item h4 {
            font-size: 17px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .note-item small {
            display: block;
            font-size: 12px;
            color: var(--color-secondary-text);
        }
        .sidebar-footer {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--color-bg);
        }
        .sidebar-footer button {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
        }
        .sidebar-footer button:hover {
            color: var(--color-accent);
        }


        #main-content {
            flex-grow: 1;
            padding: var(--padding-lg) 0; 
            display: flex;
            flex-direction: column;
            background-color: var(--color-paper);
            position: relative;
            overflow-y: auto; 
        }

        #editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 var(--padding-lg) var(--padding-lg) var(--padding-lg);
            margin-bottom: var(--padding-lg);
            border-bottom: 1px solid var(--color-sidebar-bg);
            position: sticky;
            top: 0;
            background: var(--color-paper);
            z-index: 10;
        }

        .format-buttons button, .export-actions button, #lock-note-btn, #focus-mode-btn {
            background: none;
            border: none;
            color: var(--color-text);
            padding: 8px;
            margin-right: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .format-buttons button:hover, .export-actions button:hover, #lock-note-btn:hover, #focus-mode-btn:hover {
            background-color: var(--color-sidebar-bg);
            color: var(--color-accent);
        }

        #tag-input, #export-format-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--color-sidebar-bg);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin-left: 5px;
            transition: all 0.2s;
        }
        #tag-input:focus, #export-format-select:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        .note-editor-container {
            max-width: 800px; 
            width: 100%;
            margin: 0 auto;
            padding: 0 var(--padding-lg);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #note-title {
            font-size: 2.5em;
            font-weight: 700;
            border: none;
            outline: none;
            background: transparent;
            color: var(--color-text);
            margin-bottom: 15px;
            width: 100%;
        }

        #editor-body {
            flex-grow: 1;
            outline: none;
            font-size: 1.1em;
            line-height: 1.7;
            padding-bottom: 50px;
            min-height: 50vh;
            /* Fluidic Typing Animation/Focus Effect */
            transition: box-shadow 0.5s ease-out; 
            border-radius: 4px;
        }
        #editor-body:focus {
             box-shadow: 0 0 0 1px var(--color-accent);
        }

        [contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: var(--color-secondary-text);
        }

        .tag-chip {
            display: inline-block;
            background-color: var(--color-accent);
            color: white;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 13px;
            margin-right: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.2s, transform 0.2s;
        }
        .tag-chip:hover { 
            opacity: 1; 
            transform: translateY(-1px);
        }

        /* Quick Action Menu */
        #quick-action-menu {
            position: absolute;
            background: var(--color-paper);
            border: 1px solid var(--color-sidebar-bg);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            z-index: 1000;
            padding: 5px;
            width: 250px;
        }
        .quick-action-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .quick-action-item:hover {
            background: var(--color-sidebar-bg);
            color: var(--color-accent);
        }

        /* Focus Mode */
        #focus-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-paper);
            z-index: 2000;
            padding: 50px;
            display: none; 
            flex-direction: column;
            align-items: center;
        }

        #focus-content {
            max-width: 900px;
            width: 100%;
            font-size: 1.3em;
            line-height: 1.8;
            padding-top: 50px;
            outline: none;
            transition: box-shadow 0.5s ease-out; 
        }
        #focus-content:focus {
            box-shadow: 0 0 0 1px var(--color-accent);
        }

        #exit-focus-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: var(--color-accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="light-mode">
    
    <div id="auth-screen">
        <div class="auth-container">
            <h1>Noteworthy</h1>
            <p style="margin-bottom: 25px; color: var(--color-secondary-text);">A modern, focused cloud note-taking experience.</p>

            <button class="auth-button google-auth" id="google-sign-in-btn">
                <i class="fab fa-google"></i> Sign in with Google
            </button>

            <div class="separator">OR</div>

            <button class="auth-button email-auth" id="email-sign-in-btn">
                <i class="fas fa-envelope"></i> Sign in with Email/Password
            </button>
            <p class="limited-hint">Email accounts require setup in the full app version.</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>Noteworthy</h2>
                <button id="toggle-mode" title="Toggle Light/Dark Mode"><i class="fas fa-moon"></i></button>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search notes (e.g., 'locked', #tag)">
            </div>
            <div id="tag-chips-container">
                </div>
            <button id="add-note-btn" class="sidebar-action-btn"><i class="fas fa-plus"></i> New Note</button>
            <div id="notes-list">
                </div>
            <div class="sidebar-footer">
                <button id="import-btn" title="Import Backup"><i class="fas fa-file-import"></i> Import</button>
                <button id="export-backup-btn" title="Export Backup"><i class="fas fa-file-export"></i> Export</button>
                <button id="sign-out-btn" title="Sign Out"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
                <input type="file" id="file-input" accept=".json" style="display: none;">
            </div>
        </aside>

        <main id="main-content">
            <div id="editor-toolbar">
                <div class="format-buttons">
                    <button data-action="bold" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
                    <button data-action="italic" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
                    <button data-action="underline" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
                    <button data-action="formatBlock" data-value="H1" title="Heading 1"><i class="fas fa-heading"></i></button>
                    <button data-action="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                    <button id="focus-mode-btn" title="Focus Mode (Full Screen)"><i class="fas fa-arrows-alt-h"></i></button>
                </div>
                <div class="export-actions">
                    <input type="text" id="tag-input" placeholder="Add tags (comma-separated)" title="Add tags to the note">
                    <button id="lock-note-btn" title="Toggle Lock"><i class="fas fa-lock-open"></i></button>
                    <select id="export-format-select" title="Select export format">
                        <option value="txt">TXT</option>
                        <option value="html">HTML</option>
                        <option value="md">Markdown</option>
                        <option value="doc">Word (.doc)</option>
                    </select>
                    <button id="export-note-btn" title="Export Note"><i class="fas fa-download"></i></button>
                    <button id="delete-note-btn" title="Delete Note"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <div class="note-editor-container">
                <input type="text" id="note-title" placeholder="Untitled Note" autocomplete="off" disabled>
                <div id="editor-body" contenteditable="true" data-placeholder="Start typing or use '/' for quick actions..." disabled></div>
            </div>
            
            <div id="quick-action-menu" class="hidden">
                <div class="quick-action-item" data-action="insertUnorderedList"><i class="fas fa-list-ul"></i> Bullet List</div>
                <div class="quick-action-item" data-action="insertOrderedList"><i class="fas fa-list-ol"></i> Numbered List</div>
                <div class="quick-action-item" data-action="insertHTML" data-value='<label><input type="checkbox"> Checklist Item</label><br>'><i class="fas fa-check-square"></i> Checklist</div>
                <div class="quick-action-item" data-action="formatBlock" data-value="H2"><i class="fas fa-heading"></i> Heading 2</div>
            </div>

            <div id="focus-mode-overlay">
                <button id="exit-focus-btn"><i class="fas fa-compress-alt"></i> Exit Focus Mode</button>
                <div id="focus-content" contenteditable="true"></div>
            </div>
        </main>
    </div>

    <script type="module">
        // ====================================================================
        // --- FIREBASE IMPORTS (REQUIRED TO USE AUTH AND FIRESTORE) ---
        // We use the full CDN URLs here for a single-file solution
        // ====================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAj47-dmo2gfYkb4rh9lMJD5bQasTSKLlg",
            authDomain: "noteworthy-e76c3.firebaseapp.com",
            projectId: "noteworthy-e76c3",
            storageBucket: "noteworthy-e76c3.firebasestorage.app",
            messagingSenderId: "1022385392171",
            appId: "1:1022385392171:web:65f42981d87eed1603786e",
            measurementId: "G-3XNLP4S080"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // For analytics tracking
        
        // Initialize Auth and Firestore services
        const auth = getAuth(app); 
        const db = getFirestore(app); 

        // ====================================================================
        // --- APP STATE VARIABLES ---
        // ====================================================================
        const LOCAL_STORAGE_KEY = 'noteworthy_data';
        let notes = [];
        let activeNoteId = null;
        let currentUser = null; // Holds the Firebase User object

        // DOM Elements
        const body = document.body;
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const notesList = document.getElementById('notes-list');
        const noteTitleInput = document.getElementById('note-title');
        const editorBody = document.getElementById('editor-body');
        const searchInput = document.getElementById('search-input');
        const toggleModeBtn = document.getElementById('toggle-mode');
        const tagInput = document.getElementById('tag-input');
        const tagChipsContainer = document.getElementById('tag-chips-container');
        const lockNoteBtn = document.getElementById('lock-note-btn');
        const focusOverlay = document.getElementById('focus-mode-overlay');
        const focusContent = document.getElementById('focus-content');
        const quickActionMenu = document.getElementById('quick-action-menu');

        // ====================================================================
        // --- AUTHENTICATION FLOW ---
        // ====================================================================

        document.getElementById('google-sign-in-btn').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch((error) => {
                    alert("Google sign-in failed: " + error.message);
                });
        });

        document.getElementById('email-sign-in-btn').addEventListener('click', () => {
            // NOTE: In a production app, this would open a modal/form for email/password input.
            alert("Email/Password sign-in requires a separate form and function (e.g., createUserWithEmailAndPassword). Using Google for demo.");
        });
        
        document.getElementById('sign-out-btn').addEventListener('click', () => {
            signOut(auth).catch(error => console.error("Sign out error:", error));
        });

        // 🛡️ The core of the app: listens for login/logout changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initApp();
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                // Clean up UI/data when logged out
                notes = [];
                activeNoteId = null;
                notesList.innerHTML = '';
            }
        });

        // ====================================================================
        // --- DATA MIGRATION ---
        // ====================================================================

        async function migrateLocalNotes(uid) {
            const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!localData) return;

            const localNotes = JSON.parse(localData);
            if (localNotes.length === 0) return;

            if (confirm(`Found ${localNotes.length} notes in your browser. Do you want to migrate them to your cloud account?`)) {
                const notesCollectionRef = collection(db, `users/${uid}/notes`);
                
                for (const note of localNotes) {
                    // Use Firestore's auto-ID for new documents, but keep the data
                    await setDoc(doc(notesCollectionRef), {
                        title: note.title,
                        body: note.body,
                        tags: note.tags || [],
                        isLocked: note.isLocked || false,
                        modifiedAt: new Date(note.modifiedAt || note.createdAt),
                        createdAt: new Date(note.createdAt)
                    });
                }
                // Important: Clear local storage after successful migration
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                alert("Migration complete! Local notes deleted. Your notes are now in the cloud. ✨");
            }
        }
        
        // ====================================================================
        // --- FIRESTORE DATA SYNC & CRUD ---
        // ====================================================================

        // Get or Create User Preferences
        async function loadUserPreferences(uid) {
            const userDocRef = doc(db, 'users', uid);
            const userDoc = await getDoc(userDocRef);
            let prefs;

            if (userDoc.exists()) {
                prefs = userDoc.data();
            } else {
                // Create default preferences
                prefs = { theme: 'light-mode', lastActiveNoteId: null };
                await setDoc(userDocRef, prefs);
            }
            
            // Apply theme preference
            body.className = prefs.theme;
            
            // Migrate local data on first sign-in
            if (!userDoc.exists()) {
                await migrateLocalNotes(uid);
            }

            return prefs;
        }

        function syncNotesListener(uid, lastActiveId = null) {
            const notesCollectionRef = collection(db, `users/${uid}/notes`);
            // Query for notes, ordered by modifiedAt descending
            const q = query(notesCollectionRef, orderBy('modifiedAt', 'desc'));

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                notes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderNotesList();
                renderTagChips();
                
                if (notes.length > 0) {
                    let noteToLoad = notes[0].id;
                    if (activeNoteId) {
                        noteToLoad = activeNoteId; // Keep current note active
                    } else if (lastActiveId && notes.some(n => n.id === lastActiveId)) {
                        noteToLoad = lastActiveId; // Load last active from prefs
                    }
                    loadNote(noteToLoad);
                } else {
                    addNote(); // Create a placeholder note if none exist
                }
            }, (error) => {
                console.error("Firestore listener failed:", error);
                alert("Could not load notes in real-time. Check connection/security rules.");
            });
        }
        
        // C - Create Note
        async function addNote() {
            if (!currentUser) return;
            const notesCollectionRef = collection(db, `users/${currentUser.uid}/notes`);
            
            const newNote = {
                title: 'Untitled Note',
                body: '',
                tags: [],
                isLocked: false,
                createdAt: serverTimestamp(),
                modifiedAt: serverTimestamp()
            };

            try {
                const docRef = await setDoc(doc(notesCollectionRef), newNote);
                activeNoteId = docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        // U - Update Note
        async function updateNoteInCloud() {
            if (!activeNoteId || !currentUser) return;
            
            const noteDocRef = doc(db, `users/${currentUser.uid}/notes`, activeNoteId);
            
            const updateData = {
                title: noteTitleInput.value.trim() || 'Untitled Note',
                body: editorBody.innerHTML,
                tags: tagInput.value.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag),
                modifiedAt: serverTimestamp()
            };

            try {
                await updateDoc(noteDocRef, updateData);
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        }
        
        // D - Delete Note
        async function deleteNote() {
            if (!activeNoteId || !currentUser || !confirm("Are you sure you want to delete this cloud note?")) return;

            try {
                await deleteDoc(doc(db, `users/${currentUser.uid}/notes`, activeNoteId));
                activeNoteId = null;
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }
        
        // Toggle Lock State
        async function toggleLock() {
            if (!activeNoteId || !currentUser) return;
            const note = notes.find(n => n.id === activeNoteId);
            if (!note) return;

            const noteDocRef = doc(db, `users/${currentUser.uid}/notes`, activeNoteId);
            const newLockState = !note.isLocked;

            try {
                await updateDoc(noteDocRef, { isLocked: newLockState });
                loadNote(activeNoteId); // Force re-render lock icon and disable fields
            } catch (e) {
                console.error("Error toggling lock: ", e);
            }
        }

        // R - Load Note (UI function, data comes from snapshot)
        function loadNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            activeNoteId = id;
            noteTitleInput.value = note.title;
            editorBody.innerHTML = note.body;
            tagInput.value = note.tags.join(', ');

            // Apply lock state
            const isLocked = note.isLocked;
            noteTitleInput.disabled = isLocked;
            editorBody.disabled = isLocked;
            lockNoteBtn.innerHTML = isLocked 
                ? '<i class="fas fa-lock"></i>' 
                : '<i class="fas fa-lock-open"></i>';
            lockNoteBtn.title = isLocked ? 'Unlock Note' : 'Lock Note';

            // Highlight active note
            document.querySelectorAll('.note-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`note-${id}`);
            if(activeEl) activeEl.classList.add('active');
            
            // If in focus mode, update focus content too
            if(focusOverlay.style.display !== 'none') {
                focusContent.innerHTML = note.body;
            }
        }

        // ====================================================================
        // --- RENDERING & UI (Modified to use the 'notes' array) ---
        // ====================================================================

        function renderNotesList() {
            notesList.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase().trim();
            const showLockedOnly = searchTerm.includes('locked');

            const filteredNotes = notes.filter(note => {
                if (note.isLocked && !showLockedOnly) return false;
                
                const titleBodyMatch = note.title.toLowerCase().includes(searchTerm) || note.body.toLowerCase().includes(searchTerm);
                const tagMatch = note.tags.some(tag => tag.toLowerCase().includes(searchTerm.replace('#', '')));
                
                if (showLockedOnly) {
                    return note.isLocked;
                } else {
                    return titleBodyMatch || tagMatch;
                }
            });

            filteredNotes.forEach(note => {
                const div = document.createElement('div');
                div.className = 'note-item';
                div.id = `note-${note.id}`;
                if (note.id === activeNoteId) div.classList.add('active');
                
                // Convert Firestore Timestamp to Date for display
                const modifiedDate = note.modifiedAt && note.modifiedAt.toDate ? note.modifiedAt.toDate() : new Date(note.modifiedAt);

                div.innerHTML = `
                    <h4>${note.title} ${note.isLocked ? '<i class="fas fa-lock" style="font-size: 0.9em; margin-left: 5px;"></i>' : ''}</h4>
                    <small>${modifiedDate.toLocaleDateString()}</small>
                `;
                div.onclick = () => loadNote(note.id);
                notesList.appendChild(div);
            });
        }
        
        function renderTagChips() {
            // ... (keep tag chip logic as before)
            tagChipsContainer.innerHTML = '';
            const allTags = new Set();
            notes.forEach(note => note.tags.forEach(tag => allTags.add(tag)));

            Array.from(allTags).sort().slice(0, 15).forEach(tag => { 
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.textContent = `#${tag}`;
                chip.onclick = () => { 
                    searchInput.value = tag; 
                    renderNotesList();
                    searchInput.focus();
                };
                tagChipsContainer.appendChild(chip);
            });
        }

        // --- UI ACTIONS (Mode, Focus, etc. - mostly unchanged) ---
        
        function toggleMode() {
            body.classList.toggle('dark-mode');
            body.classList.toggle('light-mode');
            // TODO: Update preference in Firestore here
        }

        function executeFormatAction(command, value = null) {
            document.execCommand(command, false, value);
            editorBody.focus();
            updateNoteInCloud(); // Save immediately after formatting
        }

        function toggleFocusMode() {
            // ... (keep focus mode logic as before)
            const isFocusing = focusOverlay.style.display === 'flex';
            if (!activeNoteId) return;

            if (!isFocusing) {
                focusContent.innerHTML = editorBody.innerHTML;
                focusContent.setAttribute('contenteditable', 'true');
                focusOverlay.style.display = 'flex';
                focusContent.focus();
            } else {
                editorBody.innerHTML = focusContent.innerHTML;
                updateNoteInCloud();
                focusOverlay.style.display = 'none';
                editorBody.focus();
            }
        }
        
        // ... (Keep Quick Action Menu, Import/Export/Download functions as before) ...
        
        // --- Quick Action Menu Logic ---
        function showQuickActionMenu(x, y) {
            const editorContainer = document.querySelector('.note-editor-container');
            const editorRect = editorContainer.getBoundingClientRect();
            
            quickActionMenu.style.left = `${x - editorRect.left}px`;
            quickActionMenu.style.top = `${y - editorRect.top + editorBody.scrollTop}px`;
            quickActionMenu.classList.remove('hidden');
        }

        editorBody.addEventListener('keydown', (e) => {
            if (e.key === '/') {
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        showQuickActionMenu(rect.left, rect.bottom + 10);
                    }
                }, 10);
            } else if (e.key === 'Escape' || !quickActionMenu.classList.contains('hidden')) {
                quickActionMenu.classList.add('hidden');
            }
        });
        
        // Export functions (not cloud-dependent, mostly for user backup)
        function downloadFile(content, fileName, mimeType) { /* ... (as before) */ }
        function exportNote() { /* ... (as before) */ }
        function exportBackup() { /* ... (as before) */ }
        function importBackup() { /* ... (as before) */ }
        
        // --- INITIALIZATION & BINDINGS ---

        async function initApp() {
            // 1. Load User Preferences and run migration check
            const prefs = await loadUserPreferences(currentUser.uid);
            
            // 2. Start Real-time Data Listener
            syncNotesListener(currentUser.uid, prefs.lastActiveNoteId);

            // Event Listeners for CRUD/Persistence
            noteTitleInput.addEventListener('input', updateNoteInCloud);
            editorBody.addEventListener('input', updateNoteInCloud);
            tagInput.addEventListener('input', updateNoteInCloud);
            
            // Re-bind only if not already bound (safety measure)
            if (!document.getElementById('add-note-btn').hasAttribute('data-bound')) {
                searchInput.addEventListener('input', renderNotesList);
                document.getElementById('add-note-btn').addEventListener('click', addNote);
                document.getElementById('delete-note-btn').addEventListener('click', deleteNote);
                document.getElementById('lock-note-btn').addEventListener('click', toggleLock);
                
                // Add bound attribute to prevent double-binding on re-login
                document.getElementById('add-note-btn').setAttribute('data-bound', true);
            }

            // Other UI Bindings...
            // ... (Toolbar, Focus Mode, Import/Export bindings as before) ...
        }

    </script>
</body>
</html>
